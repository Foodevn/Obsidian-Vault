## Mẫu Repository (Repository Pattern)

### Giới thiệu
- Mẫu thiết kế **Repository Pattern** được sử dụng để quản lý truy cập dữ liệu, tách biệt logic nghiệp vụ khỏi logic truy cập cơ sở dữ liệu (database access).
- Trong bài học này, chúng ta sẽ tạo một giao diện (interface) generic `IRepository` để thực hiện các thao tác **CRUD** (Create, Read, Update, Delete) trên các đối tượng dữ liệu như **Category**, **Product**, **Order Header**, **Order Detail**, v.v.
- Giao diện generic giúp tái sử dụng mã nguồn và áp dụng cho nhiều loại đối tượng mà không cần viết lại code.

### Cấu trúc thư mục
- Trong dự án **Data**, tạo một thư mục mới có tên **Repository** để chứa các giao diện và triển khai của Repository Pattern.
- Tạo tệp `IRepository.cs` để định nghĩa giao diện generic.

### Giao diện IRepository
- **IRepository** là một giao diện generic, sử dụng tham số `T` để đại diện cho bất kỳ lớp nào (class) cần thực hiện các thao tác CRUD.
- Cú pháp khai báo: `IRepository<T> where T : class`.

#### Các phương thức chính
- **GetAll**: Lấy danh sách tất cả các bản ghi của một loại đối tượng.
- **GetFirstOrDefault**: Lấy một bản ghi đầu tiên dựa trên điều kiện lọc (filter) được cung cấp.
- **Add**: Thêm một đối tượng mới vào cơ sở dữ liệu.
- **Remove**: Xóa một đối tượng khỏi cơ sở dữ liệu.
- **RemoveRange**: Xóa nhiều đối tượng trong một lần gọi.

### Chi tiết các phương thức
#### 1. GetAll
- **Mô tả**: Lấy tất cả các bản ghi của loại `T` (ví dụ: tất cả các **Category**).
- **Kiểu trả về**: `IEnumerable<T>`.
- **Cú pháp**:
  ```csharp
  IEnumerable<T> GetAll();
  ```

#### 2. GetFirstOrDefault
- **Mô tả**: Lấy bản ghi đầu tiên thỏa mãn điều kiện lọc (filter) được truyền vào, thường sử dụng trong các trang chỉnh sửa (edit page) để hiển thị chi tiết một bản ghi.
- **Kiểu trả về**: `T`.
- **Tham số**: Một biểu thức LINQ (`Expression<Func<T, bool>>`) để xác transparence định điều kiện lọc.
- **Cú pháp**:
  ```csharp
  T GetFirstOrDefault(Expression<Func<T, bool>> filter);
  ```
- **Lưu ý**:
  - Sử dụng `Expression<Func<T, bool>>` để cho phép truyền điều kiện lọc động (dynamic LINQ expression).
  - Ví dụ: `GetFirstOrDefault(x => x.Id == id)` để lấy bản ghi theo ID.

#### 3. Add
- **Mô tả**: Thêm một đối tượng `T` vào cơ sở dữ liệu.
- **Tham số**: Đối tượng `T` cần thêm.
- **Cú pháp**:
  ```csharp
  void Add(T entity);
  ```

#### 4. Remove
- **Mô tả**: Xóa một đối tượng `T` khỏi cơ sở dữ liệu.
- **Tham số**: Đối tượng `T` cần xóa.
- **Cú pháp**:
  ```csharp
  void Remove(T entity);
  ```

#### 5. RemoveRange
- **Mô tả**: Xóa nhiều đối tượng `T` trong một lần gọi.
- **Tham số**: Một tập hợp các đối tượng `IEnumerable<T>`.
- **Cú pháp**:
  ```csharp
  void RemoveRange(IEnumerable<T> entities);
  ```

### Lưu ý quan trọng
- **Không bao gồm Update và SaveChanges trong IRepository**:
  - Việc cập nhật (`Update`) và lưu thay đổi (`SaveChanges`) không được đưa vào giao diện generic `IRepository`.
  - Lý do: Logic cập nhật có thể khác nhau giữa các loại đối tượng (ví dụ: cập nhật **Category** khác với cập nhật **Product**).
  - Các phương thức `Update` và `SaveChanges` sẽ được triển khai trong các repository cụ thể (như `CategoryRepository`).
- **Triển khai cụ thể**:
  - Giao diện `IRepository` sẽ được triển khai trong một lớp cụ thể (như `CategoryRepository`) để xử lý các thao tác đặc thù của từng loại đối tượng.
- **Lợi ích của generic repository**:
  - Tái sử dụng mã nguồn cho nhiều loại đối tượng.
  - Tách biệt logic truy cập dữ liệu khỏi logic nghiệp vụ.
  - Dễ dàng mở rộng và bảo trì.

### Ví dụ mã nguồn
Dưới đây là mã nguồn của giao diện `IRepository.cs`:

```csharp
using System;
using System.Collections.Generic;
using System.Linq.Expressions;

namespace Data.Repository
{
    public interface IRepository<T> where T : class
    {
        IEnumerable<T> GetAll();
        T GetFirstOrDefault(Expression<Func<T, bool>> filter);
        void Add(T entity);
        void Remove(T entity);
        void RemoveRange(IEnumerable<T> entities);
    }
}
```

### Ghi chú thêm
- **LINQ Expression**:
  - Biểu thức `Expression<Func<T, bool>>` trong `GetFirstOrDefault` cho phép sử dụng các điều kiện lọc động, thay vì chỉ dựa vào ID như phương thức `Find` của EF Core.
  - Ví dụ: Có thể lọc theo bất kỳ thuộc tính nào, như `x => x.Name == "SomeName"`.
- **Liên kết nội bộ**:
  - Xem thêm về [[LINQ]] để hiểu cách sử dụng biểu thức LINQ.
  - Tham khảo [[Entity Framework Core]] để tìm hiểu về các thao tác CRUD với EF Core.
  - Xem [[CategoryRepository]] để biết cách triển khai repository cụ thể.

### Kết luận
- Giao diện `IRepository` cung cấp một cách tiếp cận generic, linh hoạt để thực hiện các thao tác CRUD trên cơ sở dữ liệu.
- Phần triển khai cụ thể của giao diện này sẽ được trình bày trong bài học tiếp theo.