## Tạo Chức năng Thêm Danh mục (Create) trong Razor Pages

### Mục tiêu
- Tạo trang Razor để thêm danh mục mới (`Create`) trong dự án Razor Pages.
- Xử lý lỗi định tuyến và đảm bảo tích hợp với Entity Framework Core (EF Core) để lưu danh mục vào cơ sở dữ liệu.
- Cấu hình xử lý yêu cầu POST để lưu dữ liệu khi người dùng gửi biểu mẫu.

### Tạo trang Razor `Create`
1. **Thêm trang `Create.cshtml`**:
   - Trong thư mục `Pages/Categories`, nhấp chuột phải, chọn **Add > Razor Page**.
   - Chọn **Razor Page - Empty** và đặt tên là `Create.cshtml`.
   - Kết quả: Tạo tệp `Create.cshtml` (giao diện) và `Create.cshtml.cs` (Page Model).

2. **Sao chép giao diện từ MVC**:
   - Sao chép nội dung từ tệp `Views/Categories/Create.cshtml` của dự án MVC sang `Pages/Categories/Create.cshtml`.
   - **Lưu ý**: Đóng tệp gốc để tránh nhầm lẫn do tên tệp giống nhau.

3. **Chỉnh sửa giao diện `Create.cshtml`**:
   - Cập nhật chỉ thị `@model` để trỏ đến `CreateModel`:
     ```cshtml
     @page
     @model BulkyWeb_Razor_Temp.Pages.Categories.CreateModel
     ```
   - Thay đổi tag helper từ `asp-controller`/`asp-action` sang `asp-page`:
     - Liên kết "Back to List": `<a asp-page="/Categories/Index">Quay lại danh sách</a>`.
  37   - Thay `@Model.Name` thành `@Model.Category.Name` vì dữ liệu danh mục nằm trong thuộc tính `Category` của `CreateModel`.
   - Ví dụ mã `Create.cshtml`:
     ```cshtml
     @page
     @model BulkyWeb_Razor_Temp.Pages.Categories.CreateModel
     <h1>Tạo Danh mục Mới</h1>

     <form method="post">
         <div class="form-group">
             <label asp-for="Category.Name">Tên</label>
             <input asp-for="Category.Name" class="form-control" />
             <span asp-validation-for="Category.Name" class="text-danger"></span>
         </div>
         <div class="form-group">
             <label asp-for="Category.DisplayOrder">Thứ tự hiển thị</label>
             <input asp-for="Category.DisplayOrder" class="form-control" />
             <span asp-validation-for="Category.DisplayOrder" class="text-danger"></span>
         </div>
         <button type="submit" class="btn btn-primary">Tạo</button>
         <a asp-page="/Categories/Index" class="btn btn-secondary">Quay lại danh sách</a>
     </form>

     @section Scripts {
         <partial name="_ValidationScriptsPartial" />
     }
     ```

4. **Cập nhật liên kết trong `Index.cshtml`**:
   - Trong `Pages/Categories/Index.cshtml`, sửa liên kết "Tạo mới" để đảm bảo định tuyến đúng:
     ```cshtml
     <a asp-page="/Categories/Create" class="btn btn-primary">Tạo mới</a>
     ```
   - **Lưu ý**: Thêm dấu `/` trước `Categories` để đảm bảo đường dẫn tuyệt đối (`/Categories/Create`).

### Cấu hình Page Model `Create.cshtml.cs`
1. **Thêm `ApplicationDbContext` và thuộc tính `Category`**:
   - Trong `Create.cshtml.cs`, thêm constructor để tiêm `ApplicationDbContext` và thuộc tính `Category`:
     ```csharp
     using BulkyWeb_Razor_Temp.Data;
     using BulkyWeb_Razor_Temp.Models;
     using Microsoft.EntityFrameworkCore;

     namespace BulkyWeb_Razor_Temp.Pages.Categories
     {
         public class CreateModel : PageModel
         {
             private readonly ApplicationDbContext _db;
             public Category Category { get; set; }

             public CreateModel(ApplicationDbContext db)
             {
                 _db = db;
             }

             public void OnGet()
             {
                 Category = new Category();
             }
         }
     }
     ```
   - **Giải thích**:
     - `Category Category`: Thuộc tính để lưu trữ đối tượng danh mục khi tạo mới.
     - `OnGet()`: Khởi tạo một đối tượng `Category` rỗng để hiển thị biểu mẫu trống khi truy cập trang.

2. **Thêm xử lý POST (OnPost)**:
   - Để xử lý khi người dùng gửi biểu mẫu, thêm phương thức `OnPost`:
     ```csharp
     public IActionResult OnPost()
     {
         if (ModelState.IsValid)
         {
             _db.Categories.Add(Category);
             _db.SaveChanges();
             return RedirectToPage("/Categories/Index");
         }
         return Page();
     }
     ```
   - **Giải thích**:
     - `ModelState.IsValid`: Kiểm tra dữ liệu đầu vào hợp lệ (dựa trên các quy tắc xác thực trong mô hình `Category`).
     - `_db.Categories.Add(Category)`: Thêm danh mục mới vào cơ sở dữ liệu.
     - `_db.SaveChanges()`: Lưu thay đổi vào cơ sở dữ liệu.
     - `RedirectToPage("/Categories/Index")`: Chuyển hướng về trang danh sách sau khi tạo thành công.
     - `return Page()`: Nếu dữ liệu không hợp lệ, trả về trang hiện tại với thông báo lỗi.

### Kiểm tra kết quả
1. **Chạy dự án**:
   - Đặt `BulkyWeb_Razor_Temp` làm **Startup Project** và chạy ứng dụng.
   - Truy cập `/Categories` và nhấp vào **Tạo mới**.
   - Nhập thông tin danh mục (Tên, Thứ tự hiển thị) và nhấp **Tạo**.
   - Kết quả: Nếu dữ liệu hợp lệ, danh mục mới được lưu và chuyển hướng về trang `/Categories`.

2. **Xử lý lỗi định tuyến**:
   - Nếu liên kết `/Categories/Create` không hoạt động, kiểm tra:
     - Đảm bảo sử dụng `asp-page="/Categories/Create"` với dấu `/` đầu tiên.
     - Kiểm tra tệp `_Layout.cshtml` và `Index.cshtml` để đảm bảo các liên kết sử dụng đường dẫn tuyệt đối.
   - **Khác biệt với MVC**: Trong MVC, lỗi "Page not found" sẽ hiển thị nếu *Action* không tồn tại. Trong Razor Pages, nếu trang không tồn tại, ứng dụng không chuyển hướng mà vẫn hiển thị trang hiện tại.

3. **Xác thực (Validation)**:
   - Trang `Create.cshtml` tự động sử dụng các script xác thực từ `_ValidationScriptsPartial.cshtml` (được kế thừa từ `_Layout.cshtml`).
   - Nếu dữ liệu không hợp lệ (ví dụ: để trống tên), thông báo lỗi sẽ hiển thị nhờ các thẻ `asp-validation-for`.

### Ghi chú thêm
- **Xác thực**: Razor Pages tích hợp sẵn các script xác thực từ ASP.NET Core, tương tự MVC.
- **Định tuyến**: Đảm bảo sử dụng đường dẫn tuyệt đối (`/Categories/...`) trong tag helper `asp-page` để tránh lỗi định tuyến.
- **Chức năng còn lại**: Các trang `Edit` và `Delete` chưa được tạo, nên liên kết "Sửa" và "Xóa" sẽ không hoạt động. Xem video tiếp theo để triển khai: [[Thực hiện CRUD trong Razor Pages]].

### Liên kết nội bộ
- [[Razor Pages]]
- [[Model–View–Controller]]
- [[Entity Framework Core]]
- [[Thực hiện CRUD trong Razor Pages]]
- [[Cấu hình Entity Framework Core trong ASP.NET Core]]