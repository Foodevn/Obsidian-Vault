## Xử lý Yêu cầu POST và Hoàn thiện Chức năng Tạo Danh mục trong Razor Pages

### Mục tiêu
- Thêm phương thức xử lý POST (`OnPost`) trong trang `Create.cshtml` để lưu danh mục mới vào cơ sở dữ liệu.
- Hiểu cách sử dụng thuộc tính `[BindProperty]` để liên kết dữ liệu từ biểu mẫu trong Razor Pages.
- Giao bài tập triển khai chức năng chỉnh sửa (Edit) và xóa (Delete) danh mục.

### Thêm phương thức `OnPost` trong `Create.cshtml.cs`
1. **Cập nhật Page Model**:
   - Trong tệp `Pages/Categories/Create.cshtml.cs`, thêm thuộc tính `[BindProperty]` và phương thức `OnPost`:
     ```csharp
     using BulkyWeb_Razor_Temp.Data;
     using BulkyWeb_Razor_Temp.Models;
     using Microsoft.AspNetCore.Mvc;
     using Microsoft.EntityFrameworkCore;

     namespace BulkyWeb_Razor_Temp.Pages.Categories
     {
         public class CreateModel : PageModel
         {
             private readonly ApplicationDbContext _db;

             [BindProperty]
             public Category Category { get; set; }

             public CreateModel(ApplicationDbContext db)
             {
                 _db = db;
             }

             public void OnGet()
             {
                 Category = new Category();
             }

             public IActionResult OnPost()
             {
                 if (ModelState.IsValid)
                 {
                     _db.Categories.Add(Category);
                     _db.SaveChanges();
                     return RedirectToPage("/Categories/Index");
                 }
                 return Page();
             }
         }
     }
     ```
   - **Giải thích**:
     - `[BindProperty]`: Liên kết dữ liệu từ biểu mẫu với thuộc tính `Category`. Điều này đảm bảo các giá trị như `Category.Name` và `Category.DisplayOrder` được điền khi gửi biểu mẫu.
     - `OnPost()`: Xử lý yêu cầu POST khi người dùng nhấn nút "Tạo".
       - `ModelState.IsValid`: Kiểm tra dữ liệu hợp lệ dựa trên các quy tắc xác thực trong mô hình `Category`.
       - `_db.Categories.Add(Category)`: Thêm danh mục vào cơ sở dữ liệu.
       - `_db.SaveChanges()`: Lưu thay đổi.
       - `RedirectToPage("/Categories/Index")`: Chuyển hướng về trang danh sách danh mục nếu thành công.
       - `return Page()`: Trả về trang hiện tại nếu dữ liệu không hợp lệ, hiển thị thông báo lỗi.

2. **So sánh với MVC**:
   - Trong MVC, dữ liệu biểu mẫu được truyền qua tham số của *Action* (ví dụ: `public IActionResult Create(Category obj)`).
   - Trong Razor Pages, thuộc tính `[BindProperty]` thay thế việc truyền tham số, giúp dữ liệu biểu mẫu tự động liên kết với thuộc tính trong Page Model.

3. **Lựa chọn liên kết thuộc tính**:
   - **Cách 1**: Sử dụng `[BindProperty]` trên từng thuộc tính cụ thể (như `Category` ở trên).
   - **Cách 2**: Sử dụng `[BindProperties]` ở cấp Page Model để tự động liên kết tất cả các thuộc tính công khai:
     ```csharp
     [BindProperties]
     public class CreateModel : PageModel
     {
         private readonly ApplicationDbContext _db;
         public Category Category { get; set; }
         // ... phần còn lại của mã
     }
     ```
   - **Lưu ý**: `[BindProperties]` phù hợp khi có nhiều thuộc tính cần liên kết, nhưng cần cẩn thận để tránh liên kết không mong muốn.

### Kiểm tra và xử lý lỗi
1. **Chạy ứng dụng**:
   - Đặt `BulkyWeb_Razor_Temp` làm **Startup Project** và chạy.
   - Truy cập `/Categories`, nhấp **Tạo mới**, nhập dữ liệu (Tên, Thứ tự hiển thị), và nhấn **Tạo**.
   - Kết quả: Nếu dữ liệu hợp lệ, danh mục được lưu và chuyển hướng về `/Categories`.

2. **Xử lý lỗi khi `Category` là `null`**:
   - **Vấn đề**: Nếu không sử dụng `[BindProperty]`, thuộc tính `Category` trong `OnPost` sẽ là `null` vì dữ liệu biểu mẫu không được liên kết.
   - **Giải pháp**: Thêm `[BindProperty]` để đảm bảo dữ liệu từ biểu mẫu được điền vào `Category`.

3. **Kiểm tra xác thực**:
   - Nếu dữ liệu không hợp lệ (ví dụ: để trống `Name`), trang sẽ hiển thị lại với thông báo lỗi nhờ tích hợp `_ValidationScriptsPartial.cshtml`.

### Cập nhật giao diện `Create.cshtml`
- Đảm bảo các liên kết sử dụng `asp-page` với đường dẫn tuyệt đối:
  ```cshtml
  <a asp-page="/Categories/Index" class="btn btn-secondary">Quay lại danh sách</a>
  ```
- Kiểm tra các thẻ `asp-for` trỏ đúng đến `Category.Name` và `Category.DisplayOrder`.

### Bài tập
- **Triển khai chức năng chỉnh sửa (Edit)**:
  - Tạo trang `Edit.cshtml` trong `Pages/Categories`.
  - Thêm Page Model để lấy danh mục theo `Id` trong `OnGet` và cập nhật danh mục trong `OnPost`.
  - Sử dụng `[BindProperty]` để liên kết dữ liệu biểu mẫu.
- **Triển khai chức năng xóa (Delete)**:
  - Tạo trang `Delete.cshtml` trong `Pages/Categories`.
  - Hiển thị thông tin danh mục trong `OnGet` để xác nhận xóa.
  - Xử lý xóa danh mục trong `OnPost` và chuyển hướng về trang danh sách.
- **Gợi ý**:
  - Sao chép giao diện từ `Views/Categories/Edit.cshtml` và `Views/Categories/Delete.cshtml` của dự án MVC.
  - Cập nhật tag helper (`asp-page`) và các tham chiếu `@Model.Category`.
  - Tham khảo cấu hình của `Create.cshtml.cs` để xử lý `OnGet` và `OnPost`.

### Ghi chú thêm
- **Tên phương thức**: Trong Razor Pages, phương thức xử lý phải bắt đầu bằng `On` (ví dụ: `OnGet`, `OnPost`). Nếu không, yêu cầu sẽ không được xử lý.
- **Định tuyến**: Sử dụng đường dẫn tuyệt đối (`/Categories/Index`) trong `RedirectToPage` để đảm bảo chuyển hướng chính xác.
- Để tiếp tục, xem video tiếp theo để hướng dẫn chi tiết về chức năng Edit và Delete: [[Thực hiện CRUD trong Razor Pages]].

### Liên kết nội bộ
- [[Razor Pages]]
- [[Model–View–Controller]]
- [[Entity Framework Core]]
- [[Thực hiện CRUD trong Razor Pages]]
- [[Cấu hình Entity Framework Core trong ASP.NET Core]]