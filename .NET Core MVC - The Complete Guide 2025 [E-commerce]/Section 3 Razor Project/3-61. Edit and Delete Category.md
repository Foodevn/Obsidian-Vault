## Triển khai Chức năng Chỉnh sửa và Xóa Danh mục trong Razor Pages

### Mục tiêu
- Tạo các trang Razor `Edit` và `Delete` để hoàn thiện chức năng CRUD cho danh mục trong dự án Razor Pages.
- Đảm bảo giao diện và logic xử lý tương tự như trong dự án MVC.
- Giao bài tập triển khai thông báo (toastr notification) và tích hợp partial view.

### Tạo trang Razor `Edit`
1. **Thêm trang `Edit.cshtml`**:
   - Trong thư mục `Pages/Categories`, nhấp chuột phải, chọn **Add > Razor Page**, chọn **Razor Page - Empty**, và đặt tên là `Edit.cshtml`.
   - Kết quả: Tạo tệp `Edit.cshtml` (giao diện) và `Edit.cshtml.cs` (Page Model).

2. **Sao chép giao diện từ MVC**:
   - Sao chép nội dung từ `Views/Categories/Edit.cshtml` của dự án MVC sang `Pages/Categories/Edit.cshtml`.
   - Cập nhật chỉ thị `@model` và tag helper:
     ```cshtml
     @page
     @model BulkyWeb_Razor_Temp.Pages.Categories.EditModel
     <h1>Chỉnh sửa Danh mục</h1>

     <form method="post">
         <input type="hidden" asp-for="Category.Id" />
         <div class="form-group">
             <label asp-for="Category.Name">Tên</label>
             <input asp-for="Category.Name" class="form-control" />
             <span asp-validation-for="Category.Name" class="text-danger"></span>
         </div>
         <div class="form-group">
             <label asp-for="Category.DisplayOrder">Thứ tự hiển thị</label>
             <input asp-for="Category.DisplayOrder" class="form-control" />
             <span asp-validation-for="Category.DisplayOrder" class="text-danger"></span>
         </div>
         <button type="submit" class="btn btn-primary">Lưu</button>
         <a asp-page="/Categories/Index" class="btn btn-secondary">Quay lại danh sách</a>
     </form>

     @section Scripts {
         <partial name="_ValidationScriptsPartial" />
     }
     ```
   - **Lưu ý**:
     - Thay `@Model` bằng `@Model.Category` (ví dụ: `asp-for="Category.Name"`) vì dữ liệu nằm trong thuộc tính `Category` của `EditModel`.
     - Sử dụng `asp-page="/Categories/Index"` cho liên kết quay lại.

3. **Cấu hình Page Model `Edit.cshtml.cs`**:
   - Sao chép logic từ `Create.cshtml.cs` và điều chỉnh:
     ```csharp
     using BulkyWeb_Razor_Temp.Data;
     using BulkyWeb_Razor_Temp.Models;
     using Microsoft.AspNetCore.Mvc;
     using Microsoft.EntityFrameworkCore;

     namespace BulkyWeb_Razor_Temp.Pages.Categories
     {
            [BindProperty]
         public class EditModel : PageModel
         {
             private readonly ApplicationDbContext _db;

             public Category? Category { get; set; }

             public EditModel(ApplicationDbContext db)
             {
                 _db = db;
             }

             public IActionResult OnGet(int? id)
             {
                 if (id == null || id == 0)
                 {
                     return NotFound();
                 }
                 Category = _db.Categories.Find(id);
                 if (Category == null)
                 {
                     return NotFound();
                 }
                 return Page();
             }

             public IActionResult OnPost()
             {
                 if (ModelState.IsValid)
                 {
                     _db.Categories.Update(Category);
                     _db.SaveChanges();
                     return RedirectToPage("/Categories/Index");
                 }
                 return Page();
             }
         }
     }
     ```
   - **Giải thích**:
     - `OnGet(int? id)`: Nhận `id` từ URL (qua `asp-route-id`), tìm danh mục bằng `_db.Categories.Find(id)`. Nếu không tìm thấy, trả về `NotFound()`.
     - `OnPost()`: Cập nhật danh mục bằng `_db.Categories.Update(Category)` và lưu thay đổi.
     - `[BindProperty]`: Liên kết dữ liệu biểu mẫu với `Category`.

4. **Kiểm tra**:
   - Chạy ứng dụng, truy cập `/Categories`, nhấp **Sửa** trên một danh mục.
   - Chỉnh sửa thông tin và nhấn **Lưu**. Nếu hợp lệ, danh mục được cập nhật và chuyển hướng về `/Categories`.

### Tạo trang Razor `Delete`
1. **Thêm trang `Delete.cshtml`**:
   - Trong thư mục `Pages/Categories`, thêm **Razor Page - Empty** với tên `Delete.cshtml`.

2. **Sao chép giao diện từ MVC**:
   - Sao chép nội dung từ `Views/Categories/Delete.cshtml` sang `Pages/Categories/Delete.cshtml`.
   - Cập nhật `@model` và tag helper:
     ```cshtml
     @page
     @model BulkyWeb_Razor_Temp.Pages.Categories.DeleteModel
     <h1>Xóa Danh mục</h1>

     <h3>Bạn có chắc muốn xóa danh mục này?</h3>
     <div>
         <h4>Danh mục</h4>
         <hr />
         <dl class="row">
             <dt class="col-sm-2">Tên</dt>
             <dd class="col-sm-10">@Model.Category.Name</dd>
             <dt class="col-sm-2">Thứ tự hiển thị</dt>
             <dd class="col-sm-10">@Model.Category.DisplayOrder</dd>
         </dl>
         <form method="post">
             <input type="hidden" asp-for="Category.Id" />
             <button type="submit" class="btn btn-danger">Xóa</button>
             <a asp-page="/Categories/Index" class="btn btn-secondary">Quay lại danh sách</a>
         </form>
     </div>
     ```

3. **Cấu hình Page Model `Delete.cshtml.cs`**:
   - Sao chép logic từ `Edit.cshtml.cs` và điều chỉnh:
     ```csharp
     using BulkyWeb_Razor_Temp.Data;
     using BulkyWeb_Razor_Temp.Models;
     using Microsoft.AspNetCore.Mvc;
     using Microsoft.EntityFrameworkCore;

     namespace BulkyWeb_Razor_Temp.Pages.Categories
     {
             [BindProperty]
     
         public class DeleteModel : PageModel
         {
             private readonly ApplicationDbContext _db;

             public Category? Category { get; set; }

             public DeleteModel(ApplicationDbContext db)
             {
                 _db = db;
             }

             public IActionResult OnGet(int? id)
             {
                 if (id == null || id == 0)
                 {
                     return NotFound();
                 }
                 Category = _db.Categories.Find(id);
                 if (Category == null)
                 {
                     return NotFound();
                 }
                 return Page();
             }

             public IActionResult OnPost()
             {
	             Category? obj = _db.Categories.Find(Category.Id);
                 if (obj == null)
                 {
                     return NotFound();
                 }
                 _db.Categories.Remove(obj);
                 _db.SaveChanges();
                 return RedirectToPage("/Categories/Index");
             }
         }
     }
     ```
   - **Giải thích**:
     - `OnGet(int? id)`: Tải danh mục để hiển thị thông tin xác nhận xóa.
     - `OnPost()`: Xóa danh mục bằng `_db.Categories.Remove(Category)` và lưu thay đổi.

4. **Kiểm tra**:
   - Truy cập `/Categories`, nhấp **Xóa** trên một danh mục.
   - Xác nhận xóa và nhấn **Xóa**. Nếu thành công, danh mục bị xóa và chuyển hướng về `/Categories`.

### Kiểm tra và xử lý lỗi
- **Lỗi tên lớp Page Model**: Đảm bảo tên lớp trong `Edit.cshtml.cs` và `Delete.cshtml.cs` khớp với tên tệp (ví dụ: `EditModel`, `DeleteModel`). Nếu không, liên kết sẽ không hoạt động.
- **Định tuyến**: Sử dụng đường dẫn tuyệt đối (`/Categories/Index`) trong `asp-page` và `RedirectToPage`.
- **Xác thực**: Trang `Edit` tự động kế thừa xác thực từ `_ValidationScriptsPartial.cshtml`.

### Bài tập
1. **Triển khai thông báo Toastr**:
   - Thêm thư viện Toastr (hoặc tương tự) vào dự án để hiển thị thông báo khi tạo, chỉnh sửa, hoặc xóa danh mục thành công.
   - Ví dụ: Hiển thị thông báo "Đã tạo danh mục thành công!" sau khi lưu.
   - Gợi ý: Thêm mã JavaScript trong `_Layout.cshtml` hoặc sử dụng `TempData` để truyền thông báo.

2. **Tích hợp Partial View**:
   - Tạo partial view để tái sử dụng giao diện (ví dụ: biểu mẫu danh mục) trong `Create` và `Edit`.
   - Đặt partial view trong `Pages/Shared` (ví dụ: `_CategoryForm.cshtml`) và sử dụng trong `Create.cshtml` và `Edit.cshtml`.

### Ghi chú thêm
- **Tương tự MVC**: Logic và giao diện cho `Edit` và `Delete` trong Razor Pages tương tự MVC, nhưng sử dụng `asp-page` thay vì `asp-controller`/`asp-action`.
- **Quản lý tệp**: Đóng các tệp không cần thiết để tránh nhầm lẫn khi làm việc với nhiều tệp có tên tương tự.
- Xem video tiếp theo để hướng dẫn triển khai Toastr và partial view: [[Thêm Toastr và Partial View trong Razor Pages]].

### Liên kết nội bộ
- [[Razor Pages]]
- [[Model–View–Controller]]
- [[Entity Framework Core]]
- [[Thực hiện CRUD trong Razor Pages]]
- [[Thêm Toastr và Partial View trong Razor Pages]]