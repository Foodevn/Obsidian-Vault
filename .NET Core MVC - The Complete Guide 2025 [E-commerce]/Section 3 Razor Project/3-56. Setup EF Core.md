## Cấu hình Entity Framework Core trong Dự án Razor Pages

### Mục tiêu
- Hoàn thiện cấu hình Entity Framework Core (EF Core) trong dự án Razor Pages.
- Cài đặt các gói NuGet, cấu hình `ApplicationDbContext`, và thực hiện migration để tạo cơ sở dữ liệu.
- Đảm bảo quy trình tương tự như trong dự án MVC, với các lưu ý quan trọng khi làm việc với nhiều dự án trong cùng một giải pháp.

### Cài đặt các gói NuGet
#### Cách 1: Sử dụng giao diện Manage NuGet Packages
- Trong Visual Studio, nhấp chuột phải vào giải pháp (Solution) và chọn **Manage NuGet Packages for Solution**.
- Kiểm tra các gói đã cài đặt trong dự án MVC (`BulkyWeb`):
  - Ví dụ: `Microsoft.EntityFrameworkCore`, `Microsoft.EntityFrameworkCore.SqlServer`, `Microsoft.EntityFrameworkCore.Tools`.
- Chọn dự án Razor Pages (`BulkyWeb_Razor_Temp`) và cài đặt các gói tương tự với cùng phiên bản.
  - Lưu ý: Đảm bảo phiên bản gói NuGet khớp với dự án MVC để tránh xung đột.

#### Cách 2: Chỉnh sửa tệp dự án (`.csproj`)
- Mở tệp dự án của `BulkyWeb` (MVC) và sao chép phần `<ItemGroup>` chứa danh sách các gói NuGet:
  ```xml
  <ItemGroup>
      <PackageReference Include="Microsoft.EntityFrameworkCore" Version="8.0.0" />
      <PackageReference Include="Microsoft.EntityFrameworkCore.SqlServer" Version="8.0.0" />
      <PackageReference Include="Microsoft.EntityFrameworkCore.Tools" Version="8.0.0" />
  </ItemGroup>
  ```
- Mở tệp dự án của `BulkyWeb_Razor_Temp`, xóa các gói hiện có (nếu có), và dán phần `<ItemGroup>` vừa sao chép.
- Lưu tệp `.csproj`, Visual Studio sẽ tự động cài đặt các gói NuGet.
- **Lợi ích**: Nhanh chóng đồng bộ các gói NuGet giữa các dự án mà không cần cài đặt thủ công từng gói.

### Cấu hình ApplicationDbContext
1. **Tạo lớp `ApplicationDbContext`**:
   - Trong thư mục `Data`, tạo lớp `ApplicationDbContext`:
     ```csharp
     using BulkyWeb_Razor_Temp.Models;
     using Microsoft.EntityFrameworkCore;

     namespace BulkyWeb_Razor_Temp.Data
     {
         public class ApplicationDbContext : DbContext
         {
             public ApplicationDbContext(DbContextOptions<ApplicationDbContext> options)
                 : base(options)
             {
             }

             public DbSet<Category> Categories { get; set; }

             protected override void OnModelCreating(ModelBuilder modelBuilder)
             {
                 modelBuilder.Entity<Category>().HasData(
                     new Category { Id = 1, Name = "Category 1", DisplayOrder = 1 },
                     new Category { Id = 2, Name = "Category 2", DisplayOrder = 2 },
                     new Category { Id = 3, Name = "Category 3", DisplayOrder = 3 }
                 );
             }
         }
     }
     ```
   - **Lưu ý**: Không sao chép trực tiếp từ dự án MVC để tránh lỗi namespace. Hãy nhập thủ công và đảm bảo sử dụng namespace của dự án Razor Pages (`BulkyWeb_Razor_Temp`).

2. **Cấu hình chuỗi kết nối trong `Program.cs`**:
   - Thêm dịch vụ EF Core vào `Program.cs`:
     ```csharp
     using BulkyWeb_Razor_Temp.Data;
     using Microsoft.EntityFrameworkCore;

     var builder = WebApplication.CreateBuilder(args);

     // Thêm dịch vụ Razor Pages
     builder.Services.AddRazorPages();

     // Thêm dịch vụ EF Core
     builder.Services.AddDbContext<ApplicationDbContext>(options =>
         options.UseSqlServer(builder.Configuration.GetConnectionString("DefaultConnection")));

     var app = builder.Build();

     app.UseHttpsRedirection();
     app.UseStaticFiles();
     app.UseRouting();
     app.MapRazorPages();
     app.Run();
     ```
   - Đảm bảo chuỗi kết nối trong `appsettings.json` đã được cấu hình:
     ```json
     "ConnectionStrings": {
         "DefaultConnection": "Server=localhost;Database=Bulky_Razor;Trusted_Connection=True;"
     }
     ```

### Thực hiện Migration và Cập nhật Cơ sở dữ liệu
1. **Chọn dự án mặc định trong Package Manager Console**:
   - Trong Visual Studio, mở **Tools > NuGet Package Manager > Package Manager Console**.
   - Đặt dự án mặc định (Default Project) là `BulkyWeb_Razor_Temp` trong Package Manager Console.
   - **Lưu ý**: Vì giải pháp có nhiều dự án, phải chọn đúng dự án Razor Pages để tránh áp dụng migration cho dự án sai.

2. **Thêm Migration**:
   - Chạy lệnh trong Package Manager Console:
     ```
     Add-Migration AddCategoryToDb
     ```
   - Kiểm tra tệp migration được tạo trong thư mục `Migrations`:
     - Migration sẽ bao gồm lệnh tạo bảng `Categories` và chèn dữ liệu mẫu (seeding).

3. **Cập nhật cơ sở dữ liệu**:
   - Chạy lệnh:
     ```
     Update-Database
     ```
   - Kết quả:
     - Cơ sở dữ liệu `Bulky_Razor` được tạo trong SQL Server.
     - Bảng `Categories` được tạo với 3 bản ghi dữ liệu mẫu.

### Kiểm tra kết quả
- Mở SQL Server Management Studio (SSMS) và kiểm tra:
  - Cơ sở dữ liệu `Bulky_Razor`.
  - Bảng `Categories` với 3 bản ghi: `Category 1`, `Category 2`, `Category 3`.

### Ghi chú thêm
- Quy trình cấu hình EF Core trong Razor Pages tương tự như trong MVC, nhưng cần chú ý đến namespace và dự án mặc định khi làm việc với nhiều dự án trong cùng giải pháp.
- Việc chỉnh sửa trực tiếp tệp `.csproj` là cách nhanh chóng để đồng bộ các gói NuGet.
- Để tiếp tục, tham khảo video tiếp theo để thực hiện các thao tác CRUD trong Razor Pages: [[Thực hiện CRUD trong Razor Pages]].

### Liên kết nội bộ
- [[Entity Framework Core]]
- [[Razor Pages]]
- [[Cấu hình Entity Framework Core trong ASP.NET Core]]
- [[Model–View–Controller]]
- [[Thực hiện CRUD trong Razor Pages]]