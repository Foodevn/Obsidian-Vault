## Bài học: Tạo Bảng trong Cơ sở Dữ liệu bằng Migration trong Entity Framework Core

### Khái niệm về Migration
- **Migration** (Di chuyển): Là quá trình Entity Framework Core sử dụng để tạo hoặc cập nhật cấu trúc cơ sở dữ liệu (bảng, cột, ràng buộc) dựa trên các model trong mã nguồn.
- Migration giúp chuyển đổi mã C# (model và DbContext) thành các câu lệnh SQL để tạo hoặc sửa đổi cơ sở dữ liệu mà không cần viết SQL thủ công.
- Bảng `__EFMigrationsHistory` trong cơ sở dữ liệu theo dõi các migration đã được áp dụng.

### Chuẩn bị tạo bảng Category
1. **Kiểm tra Model**:
   - Đã có model `Category` với các thuộc tính:
     ```csharp
     using System.ComponentModel.DataAnnotations;

     public class Category
     {
         public int Id { get; set; }
         [Required]
         public string Name { get; set; }
         public int DisplayOrder { get; set; }
     }
     ```
   - **Lưu ý về khóa chính**:
     - Thuộc tính `Id` hoặc `<Tên_Model>Id` (ví dụ: `CategoryId`) được Entity Framework Core tự động coi là khóa chính (primary key) mà không cần chú thích `[Key]`.
     - Nếu tên thuộc tính khác (ví dụ: `Category21Id`), cần thêm `[Key]` để chỉ định khóa chính, nếu không sẽ gây lỗi.

2. **Cấu hình DbContext**:
   - Trong lớp `ApplicationDbContext`, thêm một `DbSet` để ánh xạ model `Category` tới bảng trong cơ sở dữ liệu:
     ```csharp
     using Microsoft.EntityFrameworkCore;

     public class ApplicationDbContext : DbContext
     {
         public ApplicationDbContext(DbContextOptions<ApplicationDbContext> options) : base(options)
         {
         }

         public DbSet<Category> Categories { get; set; }
     }
     ```
   - **Giải thích**:
     - `DbSet<Category>`: Đại diện cho bảng `Categories` trong cơ sở dữ liệu.
     - Tên thuộc tính `Categories` xác định tên bảng (có thể tùy chỉnh, ví dụ: `CategoryTable`).

### Thực hiện Migration
1. **Mở Package Manager Console**:
   - Trong Visual Studio, vào **Tools** > **NuGet Package Manager** > **Package Manager Console**.

2. **Thêm Migration**:
   - Chạy lệnh:
     ```
     Add-Migration AddCategoryTableToDb
     ```
   - **Giải thích**:
     - `Add-Migration`: Tạo một tệp migration chứa mã để tạo hoặc cập nhật cơ sở dữ liệu.
     - `AddCategoryTableToDb`: Tên migration, nên đặt tên mô tả rõ ràng (ví dụ: mô tả hành động tạo bảng `Category`).
   - Kết quả: Một thư mục `Migrations` được tạo trong dự án, chứa tệp migration (ví dụ: `2023..._AddCategoryTableToDb.cs`).

3. **Nội dung tệp Migration**:
   - Tệp migration chứa hai phương thức chính:
     - **Up**: Chứa mã để áp dụng thay đổi (tạo bảng `Categories` với các cột `Id`, `Name`, `DisplayOrder` và ràng buộc khóa chính).
     - **Down**: Chứa mã để hoàn tác (xóa bảng nếu cần rollback).
   - Ví dụ mã migration:
     ```csharp
     migrationBuilder.CreateTable(
         name: "Categories",
         columns: table => new
         {
             Id = table.Column<int>(nullable: false)
                 .Annotation("SqlServer:Identity", "1, 1"),
             Name = table.Column<string>(nullable: false),
             DisplayOrder = table.Column<int>(nullable: false)
         },
         constraints: table =>
         {
             table.PrimaryKey("PK_Categories", x => x.Id);
         });
     ```
   - **Giải thích**:
     - `CreateTable`: Tạo bảng `Categories`.
     - `Id`: Cột khóa chính với thuộc tính tự tăng (identity).
     - `Name`: Cột không cho phép null (do `[Required]`).
     - `PrimaryKey`: Xác định `Id` là khóa chính.

4. **Áp dụng Migration**:
   - Chạy lệnh:
     ```
     Update-Database
     ```
   - **Kết quả**:
     - Entity Framework Core kiểm tra bảng `__EFMigrationsHistory` để xác định các migration chưa được áp dụng.
     - Chuyển mã migration thành câu lệnh SQL và tạo bảng `Categories` trong cơ sở dữ liệu `Bulky`.
     - Bảng `__EFMigrationsHistory` được cập nhật để ghi lại migration đã áp dụng.

### Xử lý lỗi
- **Lỗi: "Entity type 'Category' requires a primary key to be defined"**:
  - Nguyên nhân: Không có khóa chính được xác định (do tên thuộc tính không phải `Id` hoặc `<Tên_Model>Id` và thiếu `[Key]`).
  - Khắc phục: Đổi tên thuộc tính thành `Id` hoặc thêm `[Key]` cho thuộc tính (ví dụ: `Category21Id`).
- **Lỗi chuỗi kết nối**: Đảm bảo chuỗi kết nối trong `appsettings.json` và `Program.cs` chính xác.

### Kiểm tra kết quả
- Trong SQL Server Management Studio (SSMS):
  - Làm mới cơ sở dữ liệu `Bulky`.
  - Kiểm tra bảng `Categories` với các cột `Id`, `Name`, `DisplayOrder`.
  - Kiểm tra bảng `__EFMigrationsHistory` để xác nhận migration đã được áp dụng.

### Tổng kết quy trình tạo bảng
1. Tạo model (ví dụ: `Category`) với các thuộc tính.
2. Thêm `DbSet` trong `ApplicationDbContext` để ánh xạ model tới bảng.
3. Chạy lệnh `Add-Migration <Tên_Migration>` để tạo tệp migration.
4. Chạy lệnh `Update-Database` để áp dụng migration và tạo bảng trong cơ sở dữ liệu.

### Ghi chú thêm
- Migration giúp đơn giản hóa việc quản lý cơ sở dữ liệu mà không cần viết SQL thủ công.
- Nếu cần hoàn tác migration, sử dụng lệnh `Remove-Migration` (chỉ áp dụng nếu migration chưa được áp dụng vào cơ sở dữ liệu).
- Entity Framework Core tự động xử lý các chi tiết như cột tự tăng (identity) hoặc ràng buộc khóa chính.

### Liên kết nội bộ
- [[Entity Framework Core]]
- [[Migration]]
- [[DbContext]]
- [[DbSet]]
- [[Package Manager Console]]