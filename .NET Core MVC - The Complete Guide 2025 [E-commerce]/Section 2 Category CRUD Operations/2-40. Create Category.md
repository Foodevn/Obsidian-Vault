## Xử Lý Biểu Mẫu POST và Thêm Danh Mục Mới với Entity Framework Core

### Mục tiêu
- Xử lý yêu cầu POST từ biểu mẫu tạo danh mục để lưu dữ liệu vào cơ sở dữ liệu.
- Sử dụng **Entity Framework Core** để thêm danh mục mới một cách đơn giản, không cần viết câu lệnh SQL.
- Chuyển hướng người dùng về trang danh sách danh mục sau khi thêm thành công.

### Khái niệm cơ bản
- **Yêu cầu POST**: Khi người dùng nhấn nút "Tạo" trong biểu mẫu, dữ liệu được gửi qua phương thức POST đến cùng điểm cuối `/Category/Create`.
- **Liên kết mô hình (Model Binding)**: ASP.NET Core tự động ánh xạ dữ liệu từ biểu mẫu vào đối tượng mô hình `Category` dựa trên các thuộc tính được khai báo trong `asp-for`.
- **Entity Framework Core**: Công cụ ORM giúp thực hiện các thao tác cơ sở dữ liệu (thêm, sửa, xóa, truy vấn) mà không cần viết SQL thủ công.
- **Chuyển hướng hành động (Redirect to Action)**: Sau khi lưu dữ liệu, chuyển hướng người dùng đến hành động `Index` để hiển thị danh sách danh mục đã cập nhật.

### Các bước thực hiện

#### 1. Tạo phương thức hành động POST
- Thêm phương thức hành động `Create` trong **Category Controller** để xử lý yêu cầu POST.
- Phương thức này có cùng tên `Create` nhưng được đánh dấu với `[HttpPost]` để phân biệt với phương thức GET.
- Cú pháp:
  ```csharp
  [HttpPost]
  public IActionResult Create(Category obj)
  {
      _db.Categories.Add(obj);
      _db.SaveChanges();
      return RedirectToAction("Index");
  }
  ```
- **Giải thích**:
  - `Category obj`: Đối tượng `Category` được tạo từ dữ liệu biểu mẫu, chứa các giá trị như `Name` và `DisplayOrder`. Thuộc tính `Id` mặc định là 0 vì đây là bản ghi mới.
  - `_db.Categories.Add(obj)`: Đánh dấu đối tượng `Category` để thêm vào bảng `Categories` trong cơ sở dữ liệu.
  - `_db.SaveChanges()`: Thực thi lệnh thêm bản ghi vào cơ sở dữ liệu.
  - `RedirectToAction("Index")`: Chuyển hướng đến phương thức `Index` trong cùng bộ điều khiển để hiển thị danh sách danh mục.

#### 2. Thêm danh mục với Entity Framework Core
- **Quy trình**:
  - `_db.Categories.Add(obj)`: Thêm đối tượng vào tập hợp `Categories` trong **DbContext**, đánh dấu nó để thêm vào cơ sở dữ liệu.
  - `_db.SaveChanges()`: Gửi các thay đổi (đã được theo dõi) đến cơ sở dữ liệu để thực thi. Điều này tạo ra một bản ghi mới với `Id` được tự động gán bởi cơ sở dữ liệu.
- **Lợi ích**:
  - Không cần viết câu lệnh SQL INSERT.
  - Entity Framework Core tự động quản lý kết nối cơ sở dữ liệu và thực thi lệnh.
  - **Change Tracking**: Theo dõi các thay đổi trong bộ nhớ tạm thời, chỉ thực thi khi gọi `SaveChanges()`, giúp tối ưu hóa hiệu suất bằng cách gộp nhiều thao tác vào một lần truy cập cơ sở dữ liệu.

#### 3. Chuyển hướng sau khi thêm
- Sử dụng `RedirectToAction("Index")` để chuyển hướng về hành động `Index`, nơi danh sách danh mục được tải lại từ cơ sở dữ liệu.
- **Lưu ý**:
  - Nếu chuyển hướng đến bộ điều khiển khác, sử dụng `RedirectToAction("Index", "Category")` để chỉ định rõ bộ điều khiển.
  - Trong cùng bộ điều khiển, chỉ cần cung cấp tên hành động (`Index`).

#### 4. Kiểm tra và gỡ lỗi
- Thêm điểm dừng (breakpoint) trong phương thức `Create` (POST) để kiểm tra:
  - Giá trị của `obj.Name` và `obj.DisplayOrder` được lấy từ biểu mẫu.
  - `obj.Id` là 0 vì đây là bản ghi mới.
- Chạy ứng dụng, truy cập `/Category/Create`, nhập dữ liệu (ví dụ: `Name = "Test Category"`, `DisplayOrder = 5`), nhấn "Tạo":
  - Kiểm tra `obj` tại breakpoint để đảm bảo dữ liệu đúng.
  - Sau khi thực thi `_db.SaveChanges()`, kiểm tra cơ sở dữ liệu (SQL Server) để xác nhận bản ghi mới đã được thêm.
  - Xác minh người dùng được chuyển hướng về `/Category/Index` với danh sách danh mục đã cập nhật.

### Ghi chú thêm
- **Đơn giản hóa với Entity Framework Core**: Không cần quản lý kết nối cơ sở dữ liệu hoặc viết SQL thủ công, mọi thứ được xử lý tự động.
- **Tối ưu hiệu suất**: `SaveChanges()` gộp các thay đổi để thực thi trong một lần truy cập cơ sở dữ liệu, giảm tải cho hệ thống.
- **Liên kết chéo**:
  - Xem `[[Entity Framework Core]]` để tìm hiểu thêm về các thao tác như cập nhật hoặc xóa.
  - Xem `[[Model Binding trong ASP.NET Core]]` để hiểu sâu hơn về cách ánh xạ dữ liệu từ biểu mẫu.
  - Xem `[[Xác thực biểu mẫu]]` để thêm xác thực dữ liệu trước khi lưu.

### Ví dụ
- Người dùng nhập `Name = "Test Category"`, `DisplayOrder = 5` và nhấn "Tạo":
  - Dữ liệu được gửi qua POST đến `/Category/Create`.
  - Đối tượng `Category` được tạo với `Id = 0`, `Name = "Test Category"`, `DisplayOrder = 5`.
  - Sau khi gọi `_db.SaveChanges()`, bản ghi được thêm vào bảng `Categories` với `Id` tự động tăng.
  - Người dùng được chuyển hướng đến `/Category/Index`, hiển thị danh sách danh mục bao gồm danh mục mới.

> **Lưu ý**: Cần thêm xác thực dữ liệu (validation) để đảm bảo dữ liệu hợp lệ trước khi lưu. Xem thêm `[[Xác thực biểu mẫu]]` hoặc `[[Lưu dữ liệu danh mục]]` để tiếp tục phát triển.