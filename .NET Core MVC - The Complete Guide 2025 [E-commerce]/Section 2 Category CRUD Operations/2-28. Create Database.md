## Bài học: Tạo Cơ sở Dữ liệu và Hiểu về Migration trong Entity Framework Core

### Khái niệm
- Sau khi cấu hình **ApplicationDbContext** và chuỗi kết nối trong dự án, chúng ta có thể sử dụng **Entity Framework Core** để tạo cơ sở dữ liệu dựa trên chuỗi kết nối.
- Quá trình tạo cơ sở dữ liệu và bảng được thực hiện thông qua các lệnh migration trong **Package Manager Console** (PMC).

### Tạo Cơ sở Dữ liệu
1. **Kiểm tra cấu hình**:
   - Đảm bảo chuỗi kết nối trong `appsettings.json` đúng cú pháp:
     ```json
     {
       "ConnectionStrings": {
         "DefaultConnection": "Server=.;Database=Bulky;Trusted_Connection=True;TrustServerCertificate=True"
       }
     }
     ```
   - Đảm bảo tên khóa `DefaultConnection` trong `Program.cs` khớp với `appsettings.json`:
     ```csharp
     builder.Services.AddDbContext<ApplicationDbContext>(options =>
         options.UseSqlServer(builder.Configuration.GetConnectionString("DefaultConnection")));
     ```

2. **Sử dụng Package Manager Console**:
   - Mở Visual Studio, vào **Tools** > **NuGet Package Manager** > **Package Manager Console**.
   - Chạy lệnh:
     ```
     Update-Database
     ```
   - Lệnh này sẽ tạo cơ sở dữ liệu (ví dụ: `Bulky`) dựa trên chuỗi kết nối.

3. **Kết quả**:
   - Nếu thành công, cơ sở dữ liệu `Bulky` sẽ xuất hiện trong SQL Server Management Studio (SSMS).
   - Một bảng mặc định `dbo.__EFMigrationsHistory` được tạo để theo dõi lịch sử migration.
   - Nếu không có migration nào được áp dụng, thông báo “No migrations were applied. Database is already up to date” sẽ xuất hiện.

### Xử lý lỗi thường gặp
1. **Lỗi: "The connection string property has not been initialized"**:
   - Nguyên nhân: Tên khóa chuỗi kết nối trong `Program.cs` không khớp với `appsettings.json` (ví dụ: `DefaultConnection1` thay vì `DefaultConnection`).
   - Khắc phục: Sửa tên khóa trong `Program.cs` cho đúng.

2. **Lỗi: "Keyword not supported: server"**:
   - Nguyên nhân: Cú pháp chuỗi kết nối sai (ví dụ: sử dụng `Server:.` thay vì `Server=.;`).
   - Khắc phục: Sửa chuỗi kết nối trong `appsettings.json`, đảm bảo sử dụng dấu `=` thay vì `:`.

### Giới thiệu về Migration
- **Migration** (Di chuyển): Là quá trình Entity Framework Core sử dụng để đồng bộ cấu trúc cơ sở dữ liệu với các model trong mã nguồn.
- Bảng `__EFMigrationsHistory` lưu trữ thông tin về các migration đã được áp dụng.
- Chi tiết về migration sẽ được giải thích trong các bài học tiếp theo.

### Nhiệm vụ tiếp theo
- Tạo bảng trong cơ sở dữ liệu dựa trên model `Category` đã định nghĩa:
  ```csharp
  using System.ComponentModel.DataAnnotations;

  public class Category
  {
      [Key]
      public int Id { get; set; }

      [Required]
      public string Name { get; set; }

      public int DisplayOrder { get; set; }
  }
  ```
- Quá trình này yêu cầu sử dụng lệnh `Add-Migration` và `Update-Database`, sẽ được hướng dẫn trong bài học tiếp theo.

### Ghi chú thêm
- Lệnh `Update-Database` chỉ tạo cơ sở dữ liệu nếu nó chưa tồn tại và áp dụng các migration (nếu có).
- Đảm bảo cài đặt gói `Microsoft.EntityFrameworkCore.Tools` để sử dụng các lệnh migration trong PMC.
- Nếu gặp lỗi, kiểm tra chuỗi kết nối và cấu hình trong `Program.cs` trước khi chạy lại lệnh.

### Liên kết nội bộ
- [[Entity Framework Core]]
- [[Chuỗi kết nối (Connection String)]]
- [[DbContext]]
- [[Migration]]
- [[Package Manager Console]]