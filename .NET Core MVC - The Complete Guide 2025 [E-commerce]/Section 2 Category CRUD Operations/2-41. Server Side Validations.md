## Validation trong ASP.NET Core

### Mục tiêu
- Hiểu cách triển khai **validation** trong ASP.NET Core để kiểm tra dữ liệu đầu vào khi tạo một danh mục (category).
- Áp dụng **server-side validation** sử dụng **data annotations** và **tag helpers** để hiển thị thông báo lỗi trên giao diện.
- Tùy chỉnh thông báo lỗi và tích hợp với **ModelState** để kiểm tra tính hợp lệ của dữ liệu.

---

### Khái niệm cơ bản
- **Validation** đảm bảo dữ liệu đầu vào đáp ứng các yêu cầu trước khi lưu vào cơ sở dữ liệu.
- Trong ASP.NET Core, **data annotations** và **tag helpers** được tích hợp sẵn để đơn giản hóa quá trình validation, loại bỏ nhu cầu viết JavaScript thủ công như trong .NET truyền thống.
- **ModelState.IsValid** được sử dụng trong controller để kiểm tra tính hợp lệ của đối tượng mô hình (model) dựa trên các quy tắc validation.

---

### Cách thực hiện

#### 1. Cấu hình validation trong mô hình (Model)
- Sử dụng **data annotations** trong lớp `Category` để định nghĩa các quy tắc validation.

```csharp
public class Category
{
    [Required(ErrorMessage = "Tên danh mục là bắt buộc")]
    [MaxLength(30, ErrorMessage = "Tên danh mục không được vượt quá 30 ký tự")]
    public string Name { get; set; }

    [Range(1, 100, ErrorMessage = "Thứ tự hiển thị phải từ 1 đến 100")]
    public int DisplayOrder { get; set; }
}
```

- **Giải thích**:
  - `[Required]`: Đảm bảo trường `Name` không được để trống.
  - `[MaxLength(30)]`: Giới hạn độ dài tối đa của `Name` là 30 ký tự.
  - `[Range(1, 100)]`: Đảm bảo `DisplayOrder` nằm trong khoảng từ 1 đến 100.

#### 2. Kiểm tra validation trong Controller
- Trong phương thức `Create` của `CategoryController`, sử dụng `ModelState.IsValid` để kiểm tra tính hợp lệ của đối tượng `Category`.

```csharp
[HttpPost]
public IActionResult Create(Category category)
{
    if (ModelState.IsValid)
    {
        // Lưu danh mục vào cơ sở dữ liệu
        // ...
        return RedirectToAction("Index");
    }
    // Nếu không hợp lệ, trả về view Create với thông báo lỗi
    return View(category);
}
```

- **Giải thích**:
  - `ModelState.IsValid`: Kiểm tra tất cả các quy tắc validation được định nghĩa trong mô hình.
  - Nếu dữ liệu không hợp lệ (ví dụ: `Name` trống hoặc `DisplayOrder` ngoài khoảng 1-100), phương thức trả về view `Create` để hiển thị lỗi.

#### 3. Hiển thị thông báo lỗi trên giao diện
- Sử dụng **tag helpers** trong view để hiển thị thông báo lỗi.
- Thêm các thẻ `<span>` với `asp-validation-for` để hiển thị lỗi tương ứng với từng trường.

```html
<div class="form-group">
    <label asp-for="Name"></label>
    <input asp-for="Name" class="form-control" />
    <span asp-validation-for="Name" class="text-danger"></span>
</div>
<div class="form-group">
    <label asp-for="DisplayOrder"></label>
    <input asp-for="DisplayOrder" class="form-control" />
    <span asp-validation-for="DisplayOrder" class="text-danger"></span>
</div>
```

- **Giải thích**:
  - `asp-validation-for`: Liên kết với trường trong mô hình để hiển thị thông báo lỗi.
  - `text-danger`: Lớp Bootstrap để hiển thị thông báo lỗi màu đỏ.

#### 4. Tùy chỉnh thông báo lỗi
- Thông báo lỗi có thể được tùy chỉnh trong **data annotations** bằng thuộc tính `ErrorMessage`.

```csharp
[Range(1, 100, ErrorMessage = "Thứ tự hiển thị phải nằm trong khoảng 1-100")]
public int DisplayOrder { get; set; }
```

- **Lưu ý**: Sau khi thay đổi thông báo lỗi, cần khởi động lại ứng dụng để áp dụng thay đổi.

---

### Ví dụ minh họa
1. **Tình huống không hợp lệ**:
   - Người dùng để trống trường `Name` và nhập `DisplayOrder = 0`.
   - Khi nhấn "Create":
     - `ModelState.IsValid` trả về `false`.
     - View `Create` được trả về với các thông báo lỗi:
       - "Tên danh mục là bắt buộc"
       - "Thứ tự hiển thị phải nằm trong khoảng 1-100"

2. **Tình huống hợp lệ**:
   - Người dùng nhập `Name = "Sách"` và `DisplayOrder = 5`.
   - `ModelState.IsValid` trả về `true`, danh mục được lưu và chuyển hướng về trang `Index`.

---

### Ghi chú thêm
- **Server-side validation** đảm bảo dữ liệu được kiểm tra trước khi lưu vào cơ sở dữ liệu, tăng tính bảo mật.
- **Tag helpers** trong ASP.NET Core giúp giảm thiểu mã JavaScript, tích hợp chặt chẽ với Bootstrap để hiển thị giao diện thân thiện.
- Để kiểm tra chi tiết lỗi trong `ModelState` khi debug:
  - Đặt breakpoint trong controller.
  - Xem giá trị của `ModelState` để xác định trường nào không hợp lệ và thông báo lỗi cụ thể.
- Có thể kết hợp với **client-side validation** (sử dụng jQuery) để kiểm tra dữ liệu ngay trên trình duyệt trước khi gửi đến server.

---

### Liên kết nội bộ
- [[ASP.NET Core Tag Helpers]]: Tìm hiểu thêm về cách sử dụng tag helpers.
- [[Data Annotations]]: Tham khảo các thuộc tính validation khác.
- [[ModelState]]: Hiểu sâu hơn về cách ModelState hoạt động trong ASP.NET Core.

--- 

Ghi chú được định dạng theo chuẩn Markdown, tối ưu cho việc lưu trữ và tra cứu trong Obsidian.