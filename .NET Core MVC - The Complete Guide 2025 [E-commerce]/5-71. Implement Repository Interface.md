## Triển khai Repository Pattern

### Giới thiệu
- Phần này tập trung vào việc triển khai giao diện `IRepository` trong một lớp generic có tên `Repository`. Lớp này sẽ sử dụng **Entity Framework Core (EF Core)** để thực hiện các thao tác **CRUD** trên cơ sở dữ liệu.
- Lớp `Repository` sẽ được đặt trong thư mục **Repository** của dự án **Data**.

### Tạo lớp Repository
- **Tên lớp**: `Repository<T>` (generic, với `T` là một lớp).
- **Kế thừa**: Triển khai giao diện `IRepository<T>` đã định nghĩa trước đó.
- **Cú pháp khai báo**:
  ```csharp
  public class Repository<T> : IRepository<T> where T : class
  ```
- **Lưu ý**: Đảm bảo giao diện `IRepository` được đặt trong namespace `Bulky.DataAccess.Repository.IRepository` và thêm câu lệnh `using` tương ứng để tránh lỗi biên dịch.

### Cấu trúc lớp Repository
#### 1. Trường và Constructor
- **Trường**:
  - Một trường `private readonly ApplicationDbContext _db` để lưu trữ ngữ cảnh cơ sở dữ liệu (database context).
  - Một trường `private IDbSet<T> _dbSet` để truy cập tập hợp dữ liệu generic (tương đương với `_db.Categories` trong trường hợp cụ thể).
- **Constructor**:
  - Nhận một tham số `ApplicationDbContext` thông qua **Dependency Injection**.
  - Khởi tạo `_dbSet` bằng cách sử dụng `_db.Set<T>()` để truy cập tập hợp dữ liệu tương ứng với loại `T`.
- **Mã nguồn**:
  ```csharp
  private readonly ApplicationDbContext _db;
  private readonly IDbSet<T> _dbSet;

  public Repository(ApplicationDbContext db)
  {
      _db = db;
      _dbSet = _db.Set<T>();
  }
  ```

#### 2. Triển khai các phương thức
##### Add
- **Mô tả**: Thêm một đối tượng `T` vào cơ sở dữ liệu.
- **Cách thực hiện**: Sử dụng `_dbSet.Add(entity)` để thêm đối tượng.
- **Mã nguồn**:
  ```csharp
  public void Add(T entity)
  {
      _dbSet.Add(entity);
  }
  ```

##### GetFirstOrDefault
- **Mô tả**: Lấy bản ghi đầu tiên thỏa mãn điều kiện lọc (filter) được cung cấp.
- **Cách thực hiện**:
  - Tạo một `IQueryable<T>` từ `_dbSet`.
  - Áp dụng điều kiện lọc (`filter`) bằng phương thức `Where`.
  - Sử dụng `FirstOrDefault` để lấy bản ghi đầu tiên.
- **Mã nguồn**:
  ```csharp
  public T GetFirstOrDefault(Expression<Func<T, bool>> filter)
  {
      IQueryable<T> query = _dbSet;
      query = query.Where(filter);
      return query.FirstOrDefault();
  }
  ```

##### GetAll
- **Mô tả**: Lấy tất cả các bản ghi của loại `T`.
- **Cách thực hiện**:
  - Sử dụng `_dbSet` để truy vấn tất cả bản ghi.
  - Chuyển đổi kết quả sang `List<T>` bằng phương thức `ToList`.
- **Mã nguồn**:
  ```csharp
  public IEnumerable<T> GetAll()
  {
      IQueryable<T> query = _dbSet;
      return query.ToList();
  }
  ```

##### Remove
- **Mô tả**: Xóa một đối tượng `T` khỏi cơ sở dữ liệu.
- **Cách thực hiện**: Sử dụng `_dbSet.Remove(entity)` để xóa đối tượng.
- **Mã nguồn**:
  ```csharp
  public void Remove(T entity)
  {
      _dbSet.Remove(entity);
  }
  ```

##### RemoveRange
- **Mô tả**: Xóa nhiều đối tượng `T` trong một lần gọi.
- **Cách thực hiện**: Sử dụng `_dbSet.RemoveRange(entities)` để xóa tập hợp các đối tượng.
- **Mã nguồn**:
  ```csharp
  public void RemoveRange(IEnumerable<T> entities)
  {
      _dbSet.RemoveRange(entities);
  }
  ```

### Mã nguồn đầy đủ
Dưới đây là mã nguồn hoàn chỉnh của lớp `Repository`:

```csharp
using System;
using System.Collections.Generic;
using System.Linq;
using System.Linq.Expressions;
using Bulky.DataAccess.Data;
using Bulky.DataAccess.Repository.IRepository;

namespace Bulky.DataAccess.Repository
{
    public class Repository<T> : IRepository<T> where T : class
    {
        private readonly ApplicationDbContext _db;
        private readonly IDbSet<T> _dbSet;

        public Repository(ApplicationDbContext db)
        {
            _db = db;
            _dbSet = _db.Set<T>();
        }

        public void Add(T entity)
        {
            _dbSet.Add(entity);
        }

        public T GetFirstOrDefault(Expression<Func<T, bool>> filter)
        {
            IQueryable<T> query = _dbSet;
            query = query.Where(filter);
            return query.FirstOrDefault();
        }

        public IEnumerable<T> GetAll()
        {
            IQueryable<T> query = _dbSet;
            return query.ToList();
        }

        public void Remove(T entity)
        {
            _dbSet.Remove(entity);
        }

        public void RemoveRange(IEnumerable<T> entities)
        {
            _dbSet.RemoveRange(entities);
        }
    }
}
```

### Ghi chú thêm
- **Vai trò của _dbSet**:
  - `_dbSet` thay thế cho các tập hợp cụ thể như `_db.Categories`, cho phép lớp `Repository` hoạt động với bất kỳ loại đối tượng nào một cách generic.
  - Ví dụ: Nếu `T` là `Category`, thì `_dbSet` sẽ tương đương với `_db.Categories`.
- **Dependency Injection**:
  - `ApplicationDbContext` được thông qua constructor, đảm bảo tách biệt và dễ kiểm thử (testable).
- **Lợi ích của triển khai**:
  - Mã nguồn sạch hơn, dễ bảo trì và mở rộng.
  - Tái sử dụng cho nhiều loại đối tượng mà không cần viết lại code.
- **Liên kết nội bộ**:
  - Xem thêm về [[IRepository]] để hiểu cấu trúc giao diện generic.
  - Tham khảo [[Entity Framework Core]] để tìm hiểu về các phương thức như `Add`, `Remove`, `RemoveRange`.
  - Xem [[Dependency Injection]] để hiểu cách `ApplicationDbContext` được注入.

### Kết luận
- Lớp `Repository` đã triển khai thành công giao diện `IRepository`, cung cấp các phương thức CRUD generic.
- Phần tiếp theo sẽ tập trung vào việc sử dụng lớp này trong các repository cụ thể (như `CategoryRepository`) để xử lý các logic đặc thù.