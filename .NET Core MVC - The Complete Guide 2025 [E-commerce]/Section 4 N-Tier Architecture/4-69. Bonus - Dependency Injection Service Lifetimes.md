## Các loại vòng đời dịch vụ (Service Lifetimes) trong Dependency Injection của .NET Core

### Mục đích
- Hiểu các loại vòng đời dịch vụ (Transient, Scoped, Singleton) trong cơ chế **Dependency Injection (DI)** của .NET Core.
- Minh họa sự khác biệt giữa các vòng đời thông qua ví dụ thực tế trong ứng dụng MVC.

### Tổng quan về vòng đời dịch vụ
- **Transient**:
  - Tạo một **phiên bản mới** của dịch vụ mỗi khi được yêu cầu.
  - An toàn nhất, không tái sử dụng đối tượng, phù hợp khi không cần duy trì trạng thái.
- **Scoped**:
  - Tạo một phiên bản duy nhất cho mỗi **yêu cầu HTTP** (request).
  - Trong cùng một yêu cầu, dịch vụ được tái sử dụng; yêu cầu mới sẽ tạo phiên bản mới.
  - Được khuyến nghị cho ứng dụng web để đảm bảo tính nhất quán trong một yêu cầu.
- **Singleton**:
  - Tạo một **phiên bản duy nhất** cho toàn bộ vòng đời của ứng dụng.
  - Phiên bản này được tái sử dụng cho tất cả các yêu cầu cho đến khi ứng dụng khởi động lại.
  - Phù hợp cho các dịch vụ không thay đổi trạng thái hoặc cần chia sẻ dữ liệu toàn cục.

### Ví dụ minh họa
- **Dự án mẫu**: Tạo ứng dụng MVC với tên `DI_Service_Lifetime` để minh họa sự khác biệt giữa các vòng đời.

#### 1. Thiết lập giao diện (Interfaces)
- Tạo thư mục `Services` trong dự án.
- Tạo ba giao diện:
  - `IScopedGuidService`
  - `ISingletonGuidService`
  - `ITransientGuidService`
- Mỗi giao diện có phương thức:
  ```csharp
  public interface IScopedGuidService
  {
      string GetGuid();
  }
  // Tương tự cho ISingletonGuidService và ITransientGuidService
  ```

#### 2. Triển khai giao diện
- Tạo ba lớp triển khai tương ứng:
  - `ScopedGuidService` (triển khai `IScopedGuidService`).
  - `SingletonGuidService` (triển khai `ISingletonGuidService`).
  - `TransientGuidService` (triển khai `ITransientGuidService`).
- Mỗi lớp có cấu trúc:
  ```csharp
  public class SingletonGuidService : ISingletonGuidService
  {
      private readonly string _id;
      public SingletonGuidService()
      {
          _id = Guid.NewGuid().ToString();
      }
      public string GetGuid()
      {
          return _id;
      }
  }
  // Tương tự cho ScopedGuidService và TransientGuidService
  ```
- **Giải thích**: Mỗi lớp tạo một GUID ngẫu nhiên trong hàm khởi tạo và trả về nó qua phương thức `GetGuid`.

#### 3. Đăng ký dịch vụ trong `Program.cs`
- Đăng ký các dịch vụ với vòng đời tương ứng:
  ```csharp
  builder.Services.AddSingleton<ISingletonGuidService, SingletonGuidService>();
  builder.Services.AddScoped<IScopedGuidService, ScopedGuidService>();
  builder.Services.AddTransient<ITransientGuidService, TransientGuidService>();
  ```
- **Giải thích**:
  - `AddSingleton`: Đăng ký dịch vụ với vòng đời Singleton.
  - `AddScoped`: Đăng ký dịch vụ với vòng đời Scoped.
  - `AddTransient`: Đăng ký dịch vụ với vòng đời Transient.

#### 4. Sử dụng dịch vụ trong `HomeController`
- Tạo các trường riêng trong `HomeController` để lưu trữ các dịch vụ:
  ```csharp
  private readonly IScopedGuidService _scoped1;
  private readonly IScopedGuidService _scoped2;
  private readonly ISingletonGuidService _singleton1;
  private readonly ISingletonGuidService _singleton2;
  private readonly ITransientGuidService _transient1;
  private readonly ITransientGuidService _transient2;

  public HomeController(
      IScopedGuidService scoped1,
      IScopedGuidService scoped2,
      ISingletonGuidService singleton1,
      ISingletonGuidService singleton2,
      ITransientGuidService transient1,
      ITransientGuidService transient2)
  {
      _scoped1 = scoped1;
      _scoped2 = scoped2;
      _singleton1 = singleton1;
      _singleton2 = singleton2;
      _transient1 = transient1;
      _transient2 = transient2;
  }
  ```
- Tạo hành động `Index` để hiển thị GUID từ các dịch vụ:
  ```csharp
  public IActionResult Index()
  {
      StringBuilder messages = new StringBuilder();
      messages.AppendLine($"Transient 1: {_transient1.GetGuid()}");
      messages.AppendLine($"Transient 2: {_transient2.GetGuid()}");
      messages.AppendLine();
      messages.AppendLine($"Scoped 1: {_scoped1.GetGuid()}");
      messages.AppendLine($"Scoped 2: {_scoped2.GetGuid()}");
      messages.AppendLine();
      messages.AppendLine($"Singleton 1: {_singleton1.GetGuid()}");
      messages.AppendLine($"Singleton 2: {_singleton2.GetGuid()}");
      return Ok(messages.ToString());
  }
  ```

#### 5. Kết quả khi chạy ứng dụng
- **Transient**:
  - Mỗi lần yêu cầu dịch vụ (`_transient1`, `_transient2`), một GUID mới được tạo.
  - Ví dụ: `Transient 1` và `Transient 2` hiển thị các GUID khác nhau trong cùng một yêu cầu.
- **Scoped**:
  - Trong một yêu cầu HTTP, cả `_scoped1` và `_scoped2` trả về cùng một GUID.
  - Trong yêu cầu tiếp theo, một GUID mới được tạo.
- **Singleton**:
  - Cả `_singleton1` và `_singleton2` trả về cùng một GUID cho tất cả các yêu cầu.
  - GUID này không thay đổi cho đến khi ứng dụng khởi động lại.
- **Quan sát**:
  - Khi làm mới (refresh) trang:
    - Transient: Cả hai GUID thay đổi.
    - Scoped: Cả hai GUID thay đổi nhưng giống nhau trong cùng một yêu cầu.
    - Singleton: GUID không đổi.

### Kết luận
- **Transient**: Tạo mới mỗi lần yêu cầu, phù hợp cho các dịch vụ không cần duy trì trạng thái.
- **Scoped**: Tạo mới mỗi yêu cầu HTTP, lý tưởng cho ứng dụng web để đảm bảo tính nhất quán trong một phiên.
- **Singleton**: Tạo một lần duy nhất, dùng cho các dịch vụ toàn cục hoặc không thay đổi trạng thái.
- Scoped là lựa chọn được khuyến nghị cho ứng dụng web do tính linh hoạt và an toàn.

### Ghi chú thêm
- Hiểu rõ vòng đời dịch vụ là yếu tố quan trọng để thiết kế ứng dụng hiệu quả và tránh lỗi liên quan đến trạng thái.
- Để tìm hiểu thêm, xem: [[Dependency Injection in .NET Core]], [[ASP.NET Core Services]].

---

**Liên kết nội bộ gợi ý**:
- [[Dependency Injection in .NET Core]]: Hướng dẫn chi tiết về cơ chế DI trong .NET Core.
- [[ASP.NET Core Services]]: Cách đăng ký và sử dụng dịch vụ trong ASP.NET Core.
- [[GUID in .NET]]: Tìm hiểu về cách tạo và sử dụng GUID trong .NET.