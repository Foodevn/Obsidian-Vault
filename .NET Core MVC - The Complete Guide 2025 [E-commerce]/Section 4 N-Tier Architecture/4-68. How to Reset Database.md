## Xử lý và khởi tạo lại di cư (Migrations) trong Entity Framework Core

### Mục đích
- Hướng dẫn cách xử lý khi di cư (migrations) trong Entity Framework Core bị lỗi hoặc hỏng, và cách khởi tạo lại từ đầu một cách an toàn.
- Đảm bảo cấu hình đúng dự án **Bulky.DataAccess** để tạo và áp dụng di cư mới.

### Vấn đề
- Di cư có thể bị hỏng nếu không được quản lý cẩn thận, đặc biệt khi mới bắt đầu làm việc với Entity Framework Core.
- Các lỗi thường gặp bao gồm:
  - Không gian tên (namespace) không khớp.
  - Tham chiếu dự án hoặc gói NuGet bị thiếu.
  - Cơ sở dữ liệu hoặc tệp di cư không đồng bộ.

### Quy trình khởi tạo lại di cư

#### 1. Xóa cơ sở dữ liệu
- **Mục đích**: Xóa cơ sở dữ liệu hiện tại để bắt đầu lại từ đầu.
- **Thực hiện**:
  - Mở SQL Server Management Studio (hoặc công cụ quản lý cơ sở dữ liệu).
  - Xóa cơ sở dữ liệu **Bulky**.
- **Lưu ý**: Việc xóa cơ sở dữ liệu sẽ xóa tất cả dữ liệu hiện có, bao gồm các danh mục đã thêm trước đó.

#### 2. Xóa thư mục Migrations
- **Vị trí**: Thư mục `Migrations` trong dự án **Bulky.DataAccess**.
- **Thực hiện**:
  - Xóa toàn bộ thư mục `Migrations` để loại bỏ các tệp di cư cũ (bao gồm `.cs` và `.Designer.cs`).
- **Kết quả**: Không còn tệp di cư nào trong dự án, sẵn sàng để tạo di cư mới.

#### 3. Tạo di cư mới
- **Công cụ**: Package Manager Console (PMC) trong Visual Studio.
- **Thực hiện**:
  - Mở **Tools > NuGet Package Manager > Package Manager Console**.
  - Đặt **Default Project** trong PMC thành **Bulky.DataAccess** (vì đây là dự án chứa `ApplicationDbContext`).
  - Đảm bảo **Startup Project** vẫn là **BulkyWeb**.
  - Chạy lệnh để tạo di cư mới:
    ```powershell
    Add-Migration AddCategoryToDbAndSeedTable
    ```
  - **Giải thích**:
    - Tên di cư: `AddCategoryToDbAndSeedTable` phản ánh việc tạo bảng `Categories` và thêm dữ liệu khởi tạo (seeding).
    - Lệnh này phát hiện các thay đổi trong mô hình (chỉ có `Category` hiện tại) và tạo bảng cùng dữ liệu khởi tạo.
- **Lỗi có thể gặp**:
  - Nếu chọn sai dự án mặc định (ví dụ: **BulkyWeb**), PMC sẽ báo lỗi vì không tìm thấy `ApplicationDbContext`.
  - **Giải pháp**: Đảm bảo chọn đúng **Bulky.DataAccess** làm dự án mặc định trong PMC.

#### 4. Cập nhật cơ sở dữ liệu
- **Thực hiện**:
  - Trong Package Manager Console, chạy lệnh:
    ```powershell
    Update-Database
    ```
  - Lệnh này áp dụng di cư mới, tạo cơ sở dữ liệu **Bulky** và bảng `Categories` với dữ liệu khởi tạo.
- **Kết quả**:
  - Cơ sở dữ liệu **Bulky** được tạo lại.
  - Bảng `Categories` được tạo và chứa dữ liệu khởi tạo (seeded data).
  - Kiểm tra trong SQL Server: Làm mới (refresh) danh sách cơ sở dữ liệu, mở **Bulky > Tables > Categories** để xác nhận.

### Lưu ý
- **Hạn chế**:
  - Khi khởi tạo lại, tất cả dữ liệu trước đó (như các danh mục đã thêm) sẽ bị mất.
  - Chỉ nên thực hiện khi học hoặc trong giai đoạn phát triển, không áp dụng cho môi trường sản xuất.
- **Khắc phục lỗi di cư**:
  - Nếu di cư bị hỏng, luôn kiểm tra:
    - Không gian tên trong các tệp `.cs` và `.Designer.cs`.
    - Tham chiếu dự án và gói NuGet (`Microsoft.EntityFrameworkCore`, `Microsoft.EntityFrameworkCore.SqlServer`, `Microsoft.EntityFrameworkCore.Tools`).
  - Thay vì tìm kiếm trên Google, tập trung vào các tệp mở trong dự án (ví dụ: `ApplicationDbContext`, tệp di cư).
- **Thực hành tốt**:
  - Sao lưu cơ sở dữ liệu trước khi xóa.
  - Đặt tên di cư rõ ràng, phản ánh mục đích (ví dụ: `AddCategoryToDbAndSeedTable`).
  - Kiểm tra cấu hình dự án mặc định và startup project trước khi chạy lệnh PMC.

### Kết quả
- Cơ sở dữ liệu **Bulky** được tạo mới với bảng `Categories` và dữ liệu khởi tạo.
- Dự án **Bulky.DataAccess** quản lý di cư một cách chính xác, sẵn sàng cho các thay đổi mô hình tiếp theo.
- Ứng dụng hoạt động bình thường với cấu trúc dữ liệu mới.

### Ghi chú thêm
- Đây là phương pháp cơ bản để xử lý di cư bị hỏng trong quá trình học tập hoặc phát triển.
- Để tìm hiểu thêm về quản lý di cư, xem: [[Entity Framework Core Migrations]], [[Ngữ cảnh cơ sở dữ liệu (DB Context)]].

---

**Liên kết nội bộ gợi ý**:
- [[Entity Framework Core Migrations]]: Hướng dẫn chi tiết về tạo, quản lý và áp dụng di cư.
- [[Ngữ cảnh cơ sở dữ liệu (DB Context)]]: Cách cấu hình và sử dụng DB Context trong Entity Framework Core.
- [[Package Manager Console]]: Hướng dẫn sử dụng PMC để thực thi lệnh di cư.