## Thay thế ApplicationDbContext bằng CategoryRepository trong CategoryController

### Giới thiệu
- Phần này hướng dẫn cách thay thế việc sử dụng trực tiếp `ApplicationDbContext` bằng `CategoryRepository` trong lớp `CategoryController`.
- Mục tiêu: Sử dụng **Dependency Injection** để tiêm giao diện `ICategoryRepository` vào `CategoryController`, tận dụng các phương thức từ `CategoryRepository` thay vì truy cập trực tiếp cơ sở dữ liệu.

### Thay đổi trong CategoryController
- **Trước đây**: `CategoryController` sử dụng trực tiếp `ApplicationDbContext` để thực hiện các thao tác CRUD.
- **Bây giờ**: Sử dụng `ICategoryRepository` để truy cập các phương thức từ `CategoryRepository`, đảm bảo tuân thủ mẫu **Repository Pattern**.

#### 1. Dependency Injection trong CategoryController
- **Mô tả**: 
  - Thay vì sử dụng `ApplicationDbContext`, controller sẽ yêu cầu một thể hiện của giao diện `ICategoryRepository`.
  - Dependency Injection (DI) sẽ cung cấp triển khai cụ thể là `CategoryRepository`.
- **Cú pháp khai báo**:
trong file CategoryController.cs
  ```csharp
  private readonly ICategoryRepository _categoryRepo;

  public CategoryController(ICategoryRepository categoryRepo)
  {
      _categoryRepo = categoryRepo;
  }
  ```
- **Giải thích**:
  - Biến `_categoryRepo` thay thế `_db` (trước đây là `ApplicationDbContext`).
  - Tên `_categoryRepo` được sử dụng để rõ ràng và dễ hiểu khi gọi các phương thức của `CategoryRepository`.

#### 2. Sử dụng các phương thức từ CategoryRepository
- **Lấy danh sách tất cả danh mục (Get All)**:
  - Thay vì `_db.Categories.ToList()`, sử dụng:
  ```csharp
  _categoryRepo.GetAll()
  ```
- **Thêm danh mục (Add)**:
  - Thay vì `_db.Categories.Add(obj)`, sử dụng:
  ```csharp
  _categoryRepo.Add(obj);
  _categoryRepo.Save();
  ```
- **Cập nhật danh mục (Update)**:
  - Thay vì `_db.Categories.Update(obj)`, sử dụng:
  ```csharp
  _categoryRepo.Update(obj);
  _categoryRepo.Save();
  ```
- **Lấy danh mục để chỉnh sửa (Retrieve for Edit)**:
  - Thay vì `_db.Categories.FirstOrDefault(u => u.Id == id)`, sử dụng:
  ```csharp
  _categoryRepo.GetFirstOrDefault(u => u.Id == id)
  ```
- **Xóa danh mục (Remove)**:
  - Thay vì `_db.Categories.Remove(obj)`, sử dụng:
  ```csharp
  _categoryRepo.Remove(obj);
  _categoryRepo.Save();
  ```

### Đăng ký dịch vụ trong Dependency Injection
- **Vấn đề thường gặp**:
  - Khi chạy ứng dụng, nếu chưa đăng ký `ICategoryRepository` trong container DI, sẽ gặp lỗi:
    > "Unable to resolve service for type ICategoryRepository while attempting to activate CategoryController."
  - Nguyên nhân: Dependency Injection không biết cách cung cấp triển khai cho `ICategoryRepository`.
- **Giải pháp**:
  - Đăng ký dịch vụ `ICategoryRepository` với triển khai `CategoryRepository` trong container DI.
  - **Vị trí đăng ký**: Thường trong tệp `Program.cs` hoặc `Startup.cs`.
  - **Mã nguồn đăng ký**:
    ```csharp
    builder.Services.AddScoped<ICategoryRepository, CategoryRepository>();
    ```
  - **Giải thích**:
    - `AddScoped`: Đăng ký dịch vụ với vòng đời **scoped** (sử dụng cùng một thể hiện trong suốt một yêu cầu HTTP).
    - `ICategoryRepository`: Giao diện được yêu cầu bởi controller.
    - `CategoryRepository`: Triển khai cụ thể sẽ được DI cung cấp.

### Mã nguồn ví dụ cho CategoryController
```csharp
using Bulky.DataAccess.Repository.IRepository;
using Microsoft.AspNetCore.Mvc;

namespace BulkyWeb.Controllers
{
    public class CategoryController : Controller
    {
        private readonly ICategoryRepository _categoryRepo;

        public CategoryController(ICategoryRepository categoryRepo)
        {
            _categoryRepo = categoryRepo;
        }

        public IActionResult Index()
        {
            var categories = _categoryRepo.GetAll();
            return View(categories);
        }

        public IActionResult Create()
        {
            return View();
        }

        [HttpPost]
        public IActionResult Create(Category obj)
        {
            if (ModelState.IsValid)
            {
                _categoryRepo.Add(obj);
                _categoryRepo.Save();
                return RedirectToAction("Index");
            }
            return View(obj);
        }

        public IActionResult Edit(int id)
        {
            var category = _categoryRepo.GetFirstOrDefault(u => u.Id == id);
            if (category == null)
            {
                return NotFound();
            }
            return View(category);
        }

        [HttpPost]
        public IActionResult Edit(Category obj)
        {
            if (ModelState.IsValid)
            {
                _categoryRepo.Update(obj);
                _categoryRepo.Save();
                return RedirectToAction("Index");
            }
            return View(obj);
        }

        public IActionResult Delete(int id)
        {
            var category = _categoryRepo.GetFirstOrDefault(u => u.Id == id);
            if (category == null)
            {
                return NotFound();
            }
            return View(category);
        }

        [HttpPost, ActionName("Delete")]
        public IActionResult DeletePOST(int id)
        {
            var category = _categoryRepo.GetFirstOrDefault(u => u.Id == id);
            if (category == null)
            {
                return NotFound();
            }
            _categoryRepo.Remove(category);
            _categoryRepo.Save();
            return RedirectToAction("Index");
        }
    }
}
```

### Ghi chú quan trọng
- **Lợi ích của Repository Pattern**:
  - Loại bỏ sự phụ thuộc trực tiếp vào `ApplicationDbContext`.
  - Tăng tính tái sử dụng và dễ bảo trì mã nguồn.
  - Dễ dàng kiểm thử (unit test) nhờ sử dụng giao diện `ICategoryRepository`.
- **Vòng đời Scoped**:
  - Sử dụng `AddScoped` đảm bảo rằng một thể hiện duy nhất của `CategoryRepository` được sử dụng trong suốt một yêu cầu HTTP, tối ưu hóa hiệu suất.
- **Xử lý lỗi DI**:
  - Luôn kiểm tra xem dịch vụ đã được đăng ký trong container DI khi gặp lỗi "Unable to resolve service".
  - Đăng ký dịch vụ trong `Program.cs` hoặc `Startup.cs` là bước bắt buộc.
- **Kết quả**:
  - Sau khi thay thế và đăng ký DI, tất cả các thao tác CRUD (hiển thị danh sách, thêm, chỉnh sửa, xóa) hoạt động tương tự như khi sử dụng `ApplicationDbContext`, nhưng mã nguồn rõ ràng và tuân thủ mẫu thiết kế hơn.

### Liên kết nội bộ
- [[CategoryRepository]]: Xem chi tiết triển khai lớp `CategoryRepository`.
- [[ICategoryRepository]]: Tìm hiểu giao diện đặc thù cho `Category`.
- [[Repository Pattern]]: Hiểu về mẫu thiết kế Repository.
- [[Dependency Injection]]: Tìm hiểu cách DI hoạt động trong ASP.NET Core.
- [[Entity Framework Core]]: Tham khảo về các thao tác CRUD với EF Core.

### Kết luận
- `CategoryController` đã được cập nhật để sử dụng `ICategoryRepository` thay vì `ApplicationDbContext`, đảm bảo mã nguồn rõ ràng, dễ bảo trì và tuân thủ mẫu **Repository Pattern**.
- Đăng ký `ICategoryRepository` với `CategoryRepository` trong container DI là bước quan trọng để tránh lỗi "Unable to resolve service".