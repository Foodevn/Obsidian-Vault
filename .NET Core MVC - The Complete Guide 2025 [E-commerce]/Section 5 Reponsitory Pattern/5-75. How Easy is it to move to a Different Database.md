## Ghi chú học tập: Quản lý chuỗi kết nối và Migration trong Entity Framework Core

### Giới thiệu
- Phần này giải thích cách cập nhật chuỗi kết nối (connection string) trong tệp `appsettings.json` và sử dụng lệnh `update-database` để áp dụng các **migration** trong Entity Framework Core (EF Core).
- Mục tiêu: Đảm bảo dự án hoạt động trơn tru trên máy mới hoặc môi trường khác nhau bằng cách cập nhật chuỗi kết nối và áp dụng migration.

### Vấn đề về chuỗi kết nối
- **Tình huống**:
  - Chuỗi kết nối trong `appsettings.json` trước đây sử dụng server name là `.` (máy cục bộ), nhưng không hoạt động sau khi reset máy.
  - Nguyên nhân: Thay đổi môi trường máy tính có thể ảnh hưởng đến khả năng kết nối với SQL Server.
- **Giải pháp**:
  - Sử dụng tên server cụ thể, ví dụ: `(localdb)\MSSQLLocalDB`.
  - Cập nhật chuỗi kết nối trong tệp `appsettings.json`.
- **Cách thực hiện**:
  - Kết nối đến SQL Server (ví dụ: thông qua SQL Server Management Studio), sao chép tên server chính xác.
  - Cập nhật chuỗi kết nối trong `appsettings.json`.
  - **Lưu ý**: Nếu tên server chứa ký tự `\`, EF Core sẽ tự động thoát ký tự này thành `\\` trong chuỗi kết nối.
- **Ví dụ chuỗi kết nối**:
  ```json
  "ConnectionStrings": {
    "DefaultConnection": "Server=(localdb)\\MSSQLLocalDB;Database=Bulky;Trusted_Connection=True;MultipleActiveResultSets=true"
  }
  ```

### Sử dụng lệnh `update-database`
- **Vấn đề**: Sau khi cập nhật chuỗi kết nối, cơ sở dữ liệu `Bulky` không tồn tại trên server mới.
- **Giải pháp**:
  - Sử dụng lệnh `update-database` trong **Package Manager Console** để áp dụng tất cả các migration đã được định nghĩa trong mã nguồn.
  - Không cần tạo lại migration vì chúng đã có sẵn trong dự án.
- **Mã lệnh**:
  ```powershell
  update-database
  ```
- **Kết quả**:
  - Cơ sở dữ liệu `Bulky` được tạo.
  - Các bảng và dữ liệu khởi tạo (seeding data) được áp dụng tự động.
  - Ứng dụng hoạt động bình thường, hiển thị các danh mục (category) như trước.

### Tầm quan trọng của Migration trong EF Core
- **Migration là gì?**:
  - Migration (di chuyển) là cơ chế trong EF Core để quản lý cấu trúc cơ sở dữ liệu (schema) và dữ liệu khởi tạo.
  - Mỗi migration là một tập hợp các thay đổi (tạo bảng, thêm cột, seeding data) được lưu trong mã nguồn.
- **Lợi ích của Migration**:
  - **Tính di động**: Một nhà phát triển mới chỉ cần clone repository và chạy `update-database` để thiết lập cơ sở dữ liệu.
  - **Tính nhất quán**: Migration đảm bảo cơ sở dữ liệu trên các máy hoặc môi trường (local SQL Server, Azure SQL) có cấu trúc giống nhau.
  - **Tiết kiệm thời gian**: Không cần cấu hình thủ công nhiều bước như trước đây (giới thiệu về "good old days" khi phải tốn hàng giờ để thiết lập môi trường).
- **Quy trình thiết lập cho nhà phát triển mới**:
  1. Clone repository chứa mã nguồn.
  2. Cập nhật chuỗi kết nối trong `appsettings.json` để phù hợp với server (local SQL Server, Azure SQL, v.v.).
  3. Chạy lệnh `update-database` trong Package Manager Console.
  4. Ứng dụng sẵn sàng hoạt động với cơ sở dữ liệu được thiết lập.

### Ghi chú quan trọng
- **Chuỗi kết nối**:
  - Đảm bảo tên server trong chuỗi kết nối chính xác (ví dụ: `(localdb)\MSSQLLocalDB` thay vì `.`).
  - Kiểm tra quyền truy cập và cấu hình server trước khi chạy `update-database`.
- **Lệnh `update-database`**:
  - Chỉ cần chạy một lần để áp dụng tất cả migration hiện có.
  - Nếu có dữ liệu khởi tạo (seeding data), chúng sẽ được áp dụng tự động.
- **Ưu điểm của EF Core**:
  - Giảm thiểu thời gian thiết lập môi trường so với các công nghệ cũ (như trước đây cần xử lý nhiều phụ thuộc thủ công).
  - Hỗ trợ nhiều loại cơ sở dữ liệu (SQL Server, Azure SQL, v.v.) chỉ bằng cách thay đổi chuỗi kết nối.
- **Ứng dụng thực tế**:
  - Với dự án Bulky, sau khi cập nhật chuỗi kết nối và chạy `update-database`, các danh mục được hiển thị đúng như trước, chứng minh tính hiệu quả của EF Core.

### Liên kết nội bộ
- [[Entity Framework Core]]: Tìm hiểu về EF Core và các lệnh migration.
- [[Migration trong EF Core]]: Xem chi tiết về cách tạo và áp dụng migration.
- [[appsettings.json]]: Hiểu cách cấu hình chuỗi kết nối.
- [[CategoryRepository]]: Xem lại cách sử dụng repository để thực hiện các thao tác CRUD.
- [[Dependency Injection]]: Tìm hiểu cách DI hỗ trợ trong việc quản lý các phụ thuộc như `ApplicationDbContext`.

### Kết luận
- Việc cập nhật chuỗi kết nối và sử dụng lệnh `update-database` giúp dễ dàng thiết lập cơ sở dữ liệu trên máy mới hoặc môi trường khác.
- Migration trong EF Core đơn giản hóa việc quản lý cơ sở dữ liệu, đảm bảo tính nhất quán và tiết kiệm thời gian cho các nhà phát triển.
- Quy trình này đặc biệt hữu ích khi triển khai dự án trên các môi trường như Azure SQL hoặc khi onboard nhà phát triển mới.