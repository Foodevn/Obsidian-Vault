## Tiêm Phụ Thuộc (Dependency Injection) trong ASP.NET Core

### Mục tiêu
- Hiểu khái niệm **tiêm phụ thuộc (Dependency Injection)** và vai trò của nó trong thiết kế phần mềm.
- Nắm rõ cách áp dụng **Dependency Injection** để giảm sự phụ thuộc chặt chẽ (tight coupling) và tăng tính bảo trì.
- Hiểu qua ví dụ thực tế và cách triển khai trong ASP.NET Core.

---

### 1. Khái niệm Tiêm Phụ Thuộc
- **Định nghĩa**:
  - **Tiêm phụ thuộc (Dependency Injection)** là một mẫu thiết kế (design pattern) trong đó một lớp hoặc đối tượng nhận các phụ thuộc (dependencies) từ bên ngoài thay vì tự tạo chúng.
  - Mục đích: Giảm sự phụ thuộc chặt chẽ (tight coupling), tăng tính linh hoạt và dễ bảo trì.
- **Lợi ích**:
  - Loại bỏ việc tạo, quản lý và hủy đối tượng thủ công.
  - Giảm mã lặp lại (duplicate code).
  - Dễ dàng thay đổi hoặc nâng cấp triển khai trong tương lai.

---

### 2. Ví dụ thực tế
- **Tình huống**: Bob đi leo núi và cần chuẩn bị các vật dụng như bản đồ, đèn pin, thanh protein.
  - Bob đặt tất cả vật dụng vào một **ba lô (container)**.
  - Khi cần, Bob chỉ cần lấy vật dụng từ ba lô mà không cần tự chế tạo chúng.
- **Áp dụng vào lập trình**:
  - **Ba lô** tương đương với **Dependency Injection Container** (thùng chứa DI).
  - **Vật dụng** tương đương với các dịch vụ (services) như gửi email hoặc truy cập cơ sở dữ liệu.
  - Thay vì tạo đối tượng trực tiếp trong mã, các dịch vụ được "tiêm" từ container.

---

### 3. Tình huống không sử dụng Dependency Injection
- **Kịch bản**:
  - Ứng dụng có 3 trang (page) cần dùng chung hai chức năng: **gửi email** và **truy cập cơ sở dữ liệu (database)**.
  - Cách tiếp cận truyền thống:
    ```csharp
    // Trang 1
    var db = new Db(); // Tạo đối tượng Db
    db.GetData();      // Truy cập dữ liệu
    db.Dispose();      // Hủy đối tượng

    var email = new Email(); // Tạo đối tượng Email
    email.Send();            // Gửi email
    email.Dispose();         // Hủy đối tượng
    ```
    - Tương tự cho trang 2 và trang 3.
- **Vấn đề**:
  - **Mã lặp lại**: Mỗi trang phải tạo, sử dụng và hủy đối tượng `Db` và `Email`.
  - **Khó bảo trì**: Nếu cần thay đổi lớp `Db` thành `DbNew` hoặc `Email` thành `EmailNew`, phải sửa mã ở tất cả các trang.
  - **Khó mở rộng**: Với ứng dụng lớn (30 hoặc 300 trang), việc sửa đổi trở nên tốn thời gian và dễ lỗi.

---

### 4. Tình huống sử dụng Dependency Injection
- **Cách tiếp cận**:
  - Sử dụng một **Dependency Injection Container** để quản lý các dịch vụ.
  - Đăng ký các dịch vụ với container thông qua **interface**:
    ```csharp
    // Đăng ký trong container (thường trong Program.cs)
    services.AddScoped<IEmail, Email>();
    services.AddScoped<IDb, Db>();
    ```
  - Các trang chỉ yêu cầu **interface** (`IEmail`, `IDb`) mà không cần biết triển khai cụ thể.
- **Quy trình**:
  - Trang yêu cầu một dịch vụ (ví dụ: `IEmail`).
  - Container tự động tạo đối tượng của lớp triển khai (`Email`) và tiêm vào trang.
  - Ví dụ:
    ```csharp
    // Trang 1
    public class Page1
    {
        private readonly IEmail _email;
        private readonly IDb _db;

        public Page1(IEmail email, IDb db)
        {
            _email = email;
            _db = db;
        }

        public void Execute()
        {
            _db.GetData();   // Sử dụng dịch vụ
            _email.Send();
        }
    }
    ```
- **Lợi ích**:
  - **Không cần quản lý đối tượng**: Container lo việc tạo và hủy.
  - **Mã sạch hơn**: Trang chỉ sử dụng interface, không cần biết triển khai.
  - **Dễ thay đổi**: Nếu cần dùng `DbNew` hoặc `EmailNew`, chỉ cần thay đổi đăng ký trong container:
    ```csharp
    services.AddScoped<IEmail, EmailNew>();
    services.AddScoped<IDb, DbNew>();
    ```
  - Tất cả các trang tự động sử dụng triển khai mới mà không cần sửa đổi.

---

### 5. Dependency Injection trong ASP.NET Core
- **Tích hợp sẵn**:
  - ASP.NET Core có **Dependency Injection Container** tích hợp trong framework.
  - Đăng ký dịch vụ trong `Program.cs` hoặc `Startup.cs`:
    ```csharp
    builder.Services.AddScoped<IEmail, Email>();
    builder.Services.AddScoped<IDb, Db>();
    ```
- **Phạm vi dịch vụ**:
  - `AddScoped`: Tạo một instance cho mỗi yêu cầu HTTP.
  - `AddSingleton`: Tạo một instance duy nhất cho toàn ứng dụng.
  - `AddTransient`: Tạo instance mới mỗi khi được yêu cầu.
- **Ví dụ sử dụng trong Controller**:
  ```csharp
  public class HomeController : Controller
  {
      private readonly IEmail _email;
      private readonly IDb _db;

      public HomeController(IEmail email, IDb db)
      {
          _email = email;
          _db = db;
      }

      public IActionResult Index()
      {
          _db.GetData();
          _email.Send();
          return View();
      }
  }
  ```

---

### 6. Ghi chú thêm
- **Loose Coupling (Phụ thuộc lỏng lẻo)**:
  - Các lớp chỉ phụ thuộc vào interface, không phụ thuộc vào triển khai cụ thể.
  - Tăng khả năng mở rộng và kiểm thử (testability).
- **Liên kết nội bộ**:
  - Xem [[Dependency Injection trong ASP.NET Core]] để hiểu cách cấu hình chi tiết.
  - Xem [[Interface trong C#]] để hiểu về vai trò của interface.
  - Xem [[Cấu trúc thư mục MVC]] để kết nối với kiến trúc ứng dụng.

---

### 7. Kết luận
- **Tiêm phụ thuộc (Dependency Injection)** giúp giảm mã lặp lại, tăng tính linh hoạt và dễ bảo trì.
- **Container** quản Lý việc tạo và cung cấp các dịch vụ, giúp mã nguồn sạch và dễ mở rộng.
- Trong ASP.NET Core, DI là tính năng tích hợp sẵn, chỉ cần đăng ký dịch vụ trong `Program.cs`.
- Hiểu và áp dụng DI là kỹ năng quan trọng, đặc biệt trong các cuộc phỏng vấn kỹ thuật [[Dependency Injection trong ASP.NET Core]].