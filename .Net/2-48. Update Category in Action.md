## Hoàn Thiện Chức Năng Chỉnh Sửa và Lưu Ý về Xử Lý ID trong ASP.NET Core

### Giới thiệu
- Mục tiêu: Kiểm tra chức năng chỉnh sửa danh mục (category) và giải thích vai trò của `Id` trong việc đảm bảo cập nhật bản ghi thay vì tạo mới.
- Xử lý lỗi tiềm ẩn khi `Id` không được truyền đúng, dẫn đến tạo bản ghi mới thay vì cập nhật.
- Chuẩn bị triển khai chức năng xóa danh mục trong các video tiếp theo.
- Liên kết: [[Edit View]], [[Entity Framework Core Update]], [[Model Binding]].

### Kiểm Tra Chức Năng Chỉnh Sửa
- **Quy trình kiểm tra**:
  - Truy cập trang `Index`, nhấn nút "Edit" trên một danh mục (ví dụ: "Action").
  - Cập nhật `Name` thành "Action 111" và `Display Order` thành 5.
  - Nhấn "Update" → Danh mục được cập nhật trong database và trang chuyển hướng về `Index`.
  - Thử khôi phục giá trị ban đầu (ví dụ: "Action", `DisplayOrder` = 1) → Cập nhật thành công.
- **Kết quả**:
  - Chức năng chỉnh sửa hoạt động đúng: Dữ liệu được cập nhật trong database và hiển thị chính xác trên giao diện.
  - Xác thực phía client và server (nếu có) hoạt động như trong `Create`.

### Vai Trò của `Id` trong Action `Edit` (POST)
- **Tầm quan trọng của `Id`**:
  - `Id` xác định bản ghi cần cập nhật trong database.
  - Được truyền từ view thông qua `<input type="hidden" asp-for="Id" />` trong `Edit.cshtml`.
- **Cơ chế hoạt động**:
  - Entity Framework Core sử dụng `Id` (khóa chính) để xác định bản ghi cần cập nhật.
  - Trong action `Edit` (POST):
    ```csharp
    [HttpPost]
    public IActionResult Edit(Category obj)
    {
        if (ModelState.IsValid)
        {
            _db.Categories.Update(obj);
            _db.SaveChanges();
            return RedirectToAction("Index");
        }
        return View(obj);
    }
    ```
  - `obj.Id` được ánh xạ tự động từ form, đảm bảo Entity Framework Core cập nhật đúng bản ghi.

#### Lưu Ý Quan Trọng về `Id`
- **Trường hợp `Id` không được truyền**:
  - Nếu thiếu `<input type="hidden" asp-for="Id" />` trong `Edit.cshtml` hoặc tên tham số không khớp (ví dụ: `CategoryId` thay vì `Id`), `obj.Id` sẽ là `0`.
  - Entity Framework Core coi `Id = 0` là bản ghi mới, dẫn đến tạo mới thay vì cập nhật.
  - **Hậu quả**: Một bản ghi mới được thêm vào database với các giá trị đã chỉnh sửa, trong khi bản ghi cũ vẫn tồn tại.
- **Cách khắc phục**:
  - Đảm bảo `<input type="hidden" asp-for="Id" />` có trong form `Edit.cshtml`.
  - Nếu model sử dụng tên khác (ví dụ: `CategoryId`), thêm `<input type="hidden" asp-for="CategoryId" />`.
  - Đặt breakpoint trong action `Edit` (POST) để kiểm tra giá trị `obj.Id`:
    - Nếu `Id = 0`, kiểm tra form để đảm bảo `Id` được gửi đúng.
- **Mã nguồn ví dụ**:
  ```html
  <input type="hidden" asp-for="Id" />
  ```
- **Trường hợp đặc biệt**:
  - Nếu tên thuộc tính không phải `Id` (ví dụ: `CategoryId`), cần khai báo rõ ràng trong form và đảm bảo ánh xạ đúng trong action.

### Ghi Chú Thêm
- **Kiểm tra lỗi**:
  - Nếu phát hiện ứng dụng tạo bản ghi mới thay vì cập nhật, kiểm tra:
    1. Có `<input type="hidden" asp-for="Id" />` trong `Edit.cshtml` không.
    2. Giá trị `Id` trong `obj` khi gửi form (sử dụng breakpoint).
  - Đảm bảo tên tham số trong action `Edit` (POST) khớp với thuộc tính trong model.
- **Hiệu suất**:
  - Entity Framework Core tự động xử lý cập nhật dựa trên `Id`, không cần truy vấn SQL thủ công.
- **Chuẩn bị cho chức năng xóa**:
  - Chức năng xóa (delete) sẽ được triển khai trong các video tiếp theo, sử dụng action `Delete` và phương thức `Remove` của Entity Framework Core.
- Liên kết liên quan: [[ASP.NET Core Tag Helpers]], [[Entity Framework Core]], [[Debugging]].

### Hướng Dẫn Thao Tác
1. Kiểm tra `Edit.cshtml`:
   - Đảm bảo có `<input type="hidden" asp-for="Id" />` trong form.
   - Xác nhận form gửi đến `asp-action="Edit"` với phương thức `post`.
2. Kiểm tra action `Edit` (POST):
   - Đặt breakpoint để kiểm tra `obj.Id` có giá trị hợp lệ (không phải `0`).
   - Nếu `Id = 0`, thêm hoặc sửa input hidden trong view.
3. Chạy ứng dụng:
   - Truy cập `Index`, nhấn "Edit" trên một danh mục.
   - Thử cập nhật `Name` và `DisplayOrder`, kiểm tra kết quả trên `Index`.
   - Nếu tạo bản ghi mới thay vì cập nhật, kiểm tra `Id` như hướng dẫn.

### Chuẩn Bị cho Chức Năng Xóa
- **Mục tiêu**: Thêm action `Delete` trong `CategoryController` và view tương ứng (nếu cần).
- **Dự kiến**:
  - Action `Delete` (GET): Hiển thị xác nhận xóa.
  - Action `Delete` (POST): Xóa danh mục khỏi database bằng `_db.Categories.Remove()` và lưu thay đổi.
- Liên kết: [[Delete View]], [[Entity Framework Core Remove]].