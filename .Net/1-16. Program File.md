## Tệp Program.cs trong .NET Core

### Mục tiêu
- Hiểu vai trò của tệp `Program.cs` trong ứng dụng .NET Core.
- Nắm các thành phần chính: **dịch vụ (services)** và **đường ống xử lý yêu cầu (request pipeline)**.
- Tìm hiểu cách tệp `Program.cs` hợp nhất các chức năng từ `Program.cs` và `Startup.cs` trong các phiên bản .NET Core cũ.

### Tổng quan về `Program.cs`
- **Vai trò**:
  - Trong các phiên bản .NET Core cũ, có hai tệp: `Program.cs` và `Startup.cs`.
  - Từ .NET 6 trở đi, cả hai được hợp nhất vào tệp `Program.cs` để đơn giản hóa cấu hình.
- **Chức năng chính**:
  - **Thêm dịch vụ (services)** vào container.
  - **Cấu hình đường ống xử lý yêu cầu (request pipeline)**.

### Cấu trúc chính trong `Program.cs`

#### 1. Thêm dịch vụ (Services)
- **Cú pháp**: Sử dụng `builder.Services` để thêm các dịch vụ vào container.
- **Ví dụ**:
  - `AddControllersWithViews()`: Kích hoạt kiến trúc MVC (Model-View-Controller), cho phép ứng dụng sử dụng controllers và views.
  - Trong tương lai, các dịch vụ khác sẽ được thêm vào, ví dụ:
    - **Dependency Injection (DI)**: Tiêm các dịch vụ cần thiết (sẽ được giải thích chi tiết trong các bài học sau).
- **Ý nghĩa**:
  - Các dịch vụ được định nghĩa trong `builder.Services` cho biết ứng dụng sẽ sử dụng những thành phần nào.

#### 2. Cấu hình đường ống xử lý yêu cầu (Request Pipeline)
- **Định nghĩa**: Quy định cách xử lý các yêu cầu HTTP đến ứng dụng.
- **Các thành phần chính**:
  - **Kiểm tra môi trường**:
    - Sử dụng `app.Environment.IsDevelopment()` để kiểm tra biến môi trường `ASPNETCORE_ENVIRONMENT` (được định nghĩa trong `launchSettings.json`).
    - **Nếu là Development**:
      - Hiển thị chi tiết lỗi (exception) để hỗ trợ gỡ lỗi.
    - **Nếu không phải Development** (ví dụ: Production):
      - Sử dụng `app.UseExceptionHandler()` để chuyển hướng đến trang lỗi (error page), ví dụ: `/Home/Error`.
    - Hỗ trợ các môi trường khác: `IsProduction()`, `IsStaging()`, hoặc `IsEnvironment("Tên_môi_trường_tùy_chỉnh")`.
  - **Middleware**:
    - `app.UseHttpsRedirection()`: Chuyển hướng các yêu cầu HTTP sang HTTPS.
    - `app.UseStaticFiles()`: Kích hoạt truy cập các tệp tĩnh trong thư mục `wwwroot` (CSS, JavaScript, hình ảnh, v.v.).
    - `app.UseRouting()`: Kích hoạt định tuyến (routing) cho ứng dụng.
    - `app.UseAuthorization()`: Thêm xác thực (authorization) vào pipeline (sẽ được giải thích khi học về authentication/authorization).
  - **Định tuyến mặc định**:
    - `app.MapControllerRoute()`: Xác định mẫu định tuyến mặc định:
      - Mẫu: `{controller=Home}/{action=Index}/{id?}`
      - **Giải thích**:
        - Nếu không chỉ định route, ứng dụng mặc định gọi `HomeController` và hành động `Index`.
        - `id?`: Tham số `id` là tùy chọn (có thể null, được biểu thị bằng dấu `?`).
  - **Chạy ứng dụng**:
    - `app.Run()`: Khởi chạy ứng dụng, hoàn tất cấu hình pipeline.

### Ghi chú quan trọng
- **Tệp `Program.cs` là nơi chính để**:
  - Thêm dịch vụ vào container.
  - Cấu hình middleware trong đường ống xử lý yêu cầu.
- **Middleware pipeline**:
  - Là chuỗi các thành phần xử lý yêu cầu HTTP theo thứ tự.
  - Ví dụ: Xử lý HTTPS, phục vụ tệp tĩnh, định tuyến, xác thực, v.v.
- **Biến môi trường**:
  - Liên kết với `launchSettings.json` để điều chỉnh hành vi ứng dụng theo môi trường (Development, Production, v.v.).
- **Lưu ý cho người mới**:
  - Nếu các khái niệm như middleware, dependency injection, hoặc pipeline chưa rõ, không cần lo lắng. Chúng sẽ được giải thích chi tiết trong các bài học sau.
  - Chỉ cần nhớ: `Program.cs` là nơi cấu hình dịch vụ và pipeline.

### Liên kết nội bộ
- [[Program.cs]]
- [[Dependency Injection]]
- [[Middleware Pipeline]]
- [[ASPNETCORE_ENVIRONMENT]]
- [[wwwroot]]
- [[launchSettings.json]]
- [[MVC Architecture]]

---

**Ghi chú**: Nội dung này được diễn giải từ transcript để phục vụ ôn tập. Các khái niệm như dependency injection, middleware, hoặc authentication sẽ được giải thích chi tiết trong các bài học tiếp theo.