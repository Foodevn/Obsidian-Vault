## Bài học: Cấu hình DbContext để Kết nối Entity Framework Core với Cơ sở Dữ liệu

### Khái niệm về DbContext
- **DbContext** (Ngữ cảnh cơ sở dữ liệu): Là một lớp quan trọng trong Entity Framework Core, đóng vai trò cầu nối giữa mã nguồn và cơ sở dữ liệu.
- Lớp này kế thừa từ lớp `DbContext` trong gói `Microsoft.EntityFrameworkCore`, cho phép thực hiện các thao tác với cơ sở dữ liệu như tạo bảng, truy vấn dữ liệu.

### Tạo và Cấu hình ApplicationDbContext
1. **Tạo thư mục và lớp**:
   - Tạo một thư mục mới trong dự án có tên `Data`.
	   - Trong thư mục `Data`, tạo một lớp mới với tên `ApplicationDbContext.cs` (tên này có thể tùy chỉnh, nhưng `ApplicationDbContext` là quy ước phổ biến).

2. **Kế thừa từ DbContext**:
   - Lớp `ApplicationDbContext` phải kế thừa từ `DbContext` để sử dụng các tính năng của Entity Framework Core.
   - Thêm dòng `using Microsoft.EntityFrameworkCore;` để sử dụng lớp `DbContext`.

3. **Thêm Constructor**:
   - Tạo một constructor cho `ApplicationDbContext` để nhận các tùy chọn (options) và chuyển chúng tới lớp cơ sở `DbContext`.
   - Ví dụ mã:
     ```csharp
     using Microsoft.EntityFrameworkCore;

     public class ApplicationDbContext : DbContext
     {
         public ApplicationDbContext(DbContextOptions<ApplicationDbContext> options) : base(options)
         {
         }
     }
     ```
   - **Giải thích**:
     - `DbContextOptions<ApplicationDbContext>`: Chứa thông tin cấu hình, bao gồm chuỗi kết nối.
     - `base(options)`: Chuyển các tùy chọn tới lớp cơ sở `DbContext`.

### Đăng ký DbContext trong Program.cs
1. **Mở tệp `Program.cs`**:
   - Các dịch vụ (services) được đăng ký trong `Program.cs` trước dòng `Builder.Build()`.

2. **Thêm DbContext vào dịch vụ**:
   - Sử dụng phương thức `AddDbContext` để đăng ký `ApplicationDbContext` với Entity Framework Core.
   - Cấu hình `AddDbContext` để sử dụng SQL Server và lấy chuỗi kết nối từ `appsettings.json`.
   - Ví dụ mã:
     ```csharp
     builder.Services.AddDbContext<ApplicationDbContext>(options =>
         options.UseSqlServer(builder.Configuration.GetConnectionString("DefaultConnection")));
     ```

3. **Giải thích**:
   - `AddDbContext<ApplicationDbContext>`: Đăng ký `ApplicationDbContext` như một dịch vụ.
   - `options.UseSqlServer(...)`: Chỉ định rằng Entity Framework Core sẽ sử dụng SQL Server làm cơ sở dữ liệu.
   - `builder.Configuration.GetConnectionString("DefaultConnection")`: Lấy chuỗi kết nối từ khóa `DefaultConnection` trong `appsettings.json`.

### Lưu ý về Chuỗi Kết nối
- Chuỗi kết nối được lưu trong `appsettings.json` dưới khóa `ConnectionStrings`.
- Tên khóa `DefaultConnection` phải khớp chính xác với tên trong `appsettings.json`. Nếu không, sẽ xảy ra lỗi (ví dụ: sử dụng `DefaultConnection1` thay vì `DefaultConnection` sẽ gây lỗi).
- Ví dụ `appsettings.json`:
  ```json
  {
    "ConnectionStrings": {
      "DefaultConnection": "Server=.;Database=Bulky;Trusted_Connection=True;TrustServerCertificate=True"
    }
  }
  ```

### Lưu ý quan trọng
- Cấu hình `ApplicationDbContext` và đăng ký trong `Program.cs` là các bước cơ bản, bắt buộc để sử dụng Entity Framework Core.
- Đảm bảo tên khóa `ConnectionStrings` và `DefaultConnection` trong `appsettings.json` khớp với mã trong `Program.cs`.
- Nếu gặp lỗi do sai tên khóa, kiểm tra lại `appsettings.json` và sửa cho chính xác.

### Các bước tiếp theo
- Sau khi cấu hình `ApplicationDbContext`, cần thực hiện **migration** để tạo cơ sở dữ liệu và bảng dựa trên các model.
- Quá trình migration sẽ được giải thích trong các bài học tiếp theo.

### Liên kết nội bộ
- [[Entity Framework Core]]
- [[DbContext]]
- [[Chuỗi kết nối (Connection String)]]
- [[appsettings.json]]
- [[Migration]]