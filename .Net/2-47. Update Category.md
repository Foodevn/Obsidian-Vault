## Hoàn Thiện Trang Chỉnh Sửa Danh Mục trong ASP.NET Core

### Giới thiệu
- Mục tiêu: Tạo view `Edit.cshtml` cho chức năng chỉnh sửa danh mục (category), tái sử dụng giao diện từ `Create.cshtml` và xử lý cập nhật danh mục thông qua action `Edit` (POST).
- Dữ liệu (`Category Name`, `Display Order`) được tự động điền dựa trên đối tượng `Category` truyền từ action `Edit` (GET).
- Sử dụng Entity Framework Core để cập nhật danh mục trong database.
- Liên kết: [[Edit View]], [[Create View]], [[Entity Framework Core]].

### Tạo View `Edit.cshtml`

#### 1. Tạo View
- **Quy trình**:
  - Trong Visual Studio, chuột phải vào thư mục `Views/Category` → `Add` → `View` → chọn `Razor View`.
  - **Tên view**: `Edit`.
  - **Template**: Chọn `Empty` (không sử dụng template `Create` hoặc `Details` để tránh scaffolding tự động).
  - **Layout**: Sử dụng layout mặc định (thường là `_Layout.cshtml`) để đảm bảo giao diện nhất quán.
  - **Không chọn partial view**: Vì đây là view đầy đủ, không phải partial.
- **Lưu ý**:
  - Nếu chọn layout là `null`, view sẽ render như một trang HTML độc lập, không kế thừa giao diện từ `_Layout.cshtml`.
  - Nếu scaffolding gặp lỗi (ví dụ: lỗi ngẫu nhiên), kiểm tra lại cấu hình hoặc xóa và tạo lại view.

#### 2. Tái Sử Dụng Giao Diện từ `Create.cshtml`
- **Hành động**:
  - Sao chép toàn bộ mã từ `Create.cshtml` và dán vào `Edit.cshtml`.
  - Thay đổi tiêu đề từ "Create Category" thành "Update Category".
  - Thêm `<input type="hidden" asp-for="Id" />` để gửi `Id` về action `Edit` (POST).
- **Mã nguồn ví dụ**:
  ```html
  @model Category
  <h1>Update Category</h1>
  <form asp-action="Edit" method="post">
      <input type="hidden" asp-for="Id" />
      <div class="form-group">
          <label asp-for="Name"></label>
          <input asp-for="Name" class="form-control" />
          <span asp-validation-for="Name" class="text-danger"></span>
      </div>
      <div class="form-group">
          <label asp-for="DisplayOrder"></label>
          <input asp-for="DisplayOrder" class="form-control" />
          <span asp-validation-for="DisplayOrder" class="text-danger"></span>
      </div>
      <button type="submit" class="btn btn-primary">Update</button>
  </form>
  @section scripts {
      <partial name="_ValidationScriptsPartial" />
  }
  ```
- **Giải thích**:
  - `asp-for="Name"` và `asp-for="DisplayOrder"`: Tag helpers tự động điền giá trị từ model (`Category`) được truyền từ action `Edit` (GET).
  - `<input type="hidden" asp-for="Id" />`: Đảm bảo `Id` được gửi về server để xác định danh mục cần cập nhật.
  - Xác thực phía client được kích hoạt qua `_ValidationScriptsPartial`.

### Cập Nhật Action `Edit` (POST) trong `CategoryController`

#### 1. Cấu Hình Action
- **Mục đích**: Nhận đối tượng `Category` từ form, cập nhật dữ liệu trong database, và chuyển hướng về trang danh sách.
- **Logic**:
  - Nhận đối tượng `Category` từ form (bao gồm `Id`, `Name`, `DisplayOrder`).
  - Sử dụng Entity Framework Core để cập nhật danh mục.
  - Chuyển hướng về trang `Index` sau khi cập nhật thành công.
- **Mã nguồn**:
  ```csharp
  [HttpPost]
  public IActionResult Edit(Category obj)
  {
      if (ModelState.IsValid)
      {
          _db.Categories.Update(obj);
          _db.SaveChanges();
          return RedirectToAction("Index");
      }
      return View(obj);
  }
  ```
- **Giải thích**:
  - `_db.Categories.Update(obj)`: Đánh dấu đối tượng `Category` để cập nhật trong database, dựa trên `Id`.
  - `_db.SaveChanges()`: Lưu thay đổi vào database.
  - Entity Framework Core tự động ánh xạ các thuộc tính (`Name`, `DisplayOrder`) với bản ghi tương ứng trong database dựa trên `Id`.
  - Nếu `ModelState` không hợp lệ, trả về view `Edit` với dữ liệu đã nhập để hiển thị lỗi.

#### 2. Xử Lý Xác Thực
- Xác thực phía client: Được kích hoạt thông qua `_ValidationScriptsPartial` trong view.
- Xác thực phía server: Kiểm tra `ModelState.IsValid` trước khi cập nhật.
- Loại bỏ các xác thực tùy chỉnh không cần thiết (ví dụ: so sánh `Name` và `DisplayOrder` nếu đã có trong `Create`).

### Kết Quả
- **Giao diện**:
  - Trang `Edit` hiển thị form giống `Create`, nhưng `Category Name` và `Display Order` được điền sẵn từ dữ liệu danh mục.
  - Ví dụ: Khi chỉnh sửa danh mục có `Id = 2` (SciFi), các trường tự động hiển thị `Name = SciFi` và `DisplayOrder` tương ứng.
- **Xác thực**:
  - Xác thực phía client hoạt động ngay lập tức (ví dụ: để trống `DisplayOrder` hiển thị lỗi mà không reload trang).
  - Xác thực phía server đảm bảo dữ liệu hợp lệ trước khi cập nhật.
- **Cập nhật**:
  - Sau khi nhấn "Update", danh mục được cập nhật trong database và ứng dụng chuyển hướng về `Index`.

### Ghi Chú Thêm
- **Tự động điền dữ liệu**:
  - Tag helpers (`asp-for`) tự động hiển thị giá trị từ model, không cần mã JavaScript bổ sung.
- **Entity Framework Core**:
  - Phương thức `Update` đơn giản hóa việc cập nhật bản ghi, tự động ánh xạ dựa trên `Id`.
  - Không cần viết truy vấn SQL thủ công, giảm công sức lập trình.
- **Khả năng mở rộng**:
  - Có thể thêm thông báo thành công (ví dụ: TempData) sau khi cập nhật.
  - Có thể thêm xử lý lỗi chi tiết hơn (ví dụ: kiểm tra danh mục tồn tại trước khi cập nhật).
- **Lưu ý triển khai**:
  - Đảm bảo view `Edit.cshtml` được tạo đúng trong thư mục `Views/Category`.
  - Kiểm tra layout mặc định (`_Layout.cshtml`) được áp dụng để giao diện nhất quán.
- Liên kết liên quan: [[ASP.NET Core Tag Helpers]], [[Entity Framework Core Update]], [[Model Binding]].

### Hướng Dẫn Thao Tác
1. Tạo view `Edit.cshtml`:
   - Chuột phải vào `Views/Category` → `Add` → `Razor View` → đặt tên `Edit`, chọn layout mặc định.
   - Sao chép mã từ `Create.cshtml`, thay tiêu đề thành "Update Category", thêm `<input type="hidden" asp-for="Id" />`.
2. Cập nhật `CategoryController`:
   - Thêm action `Edit` (POST) như trên.
   - Loại bỏ các xác thực tùy chỉnh không cần thiết.
3. Chạy ứng dụng:
   - Truy cập trang `Index`, nhấn nút "Edit" trên một danh mục.
   - Kiểm tra form hiển thị dữ liệu điền sẵn và xác thực phía client.
   - Gửi form để kiểm tra cập nhật danh mục và chuyển hướng về `Index`.