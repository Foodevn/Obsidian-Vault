## Thiết Kế Trang Chỉnh Sửa Danh Mục trong ASP.NET Core

### Giới thiệu
- Mục tiêu: Tạo trang chỉnh sửa (edit) danh mục (category) tương tự trang tạo (create), nhưng tự động điền thông tin `Category Name` và `Display Order` dựa trên danh mục được chọn.
- Cần xác định danh mục cụ thể thông qua `Id` để lấy dữ liệu từ cơ sở dữ liệu (database) và truyền vào view.
- Sử dụng các phương thức của Entity Framework Core để truy xuất danh mục từ database.
- Liên kết: [[CategoryController]], [[Create View]], [[Entity Framework Core]].

### Thiết Kế Action Method trong `CategoryController`

#### 1. Action Method `Edit` (GET)
- **Mục đích**: Lấy thông tin danh mục theo `Id` và truyền vào view để hiển thị.
- **Tham số**: `int? id` (nullable để xử lý trường hợp không hợp lệ).
- **Cấu trúc**:
  - Kiểm tra `Id`:
    - Nếu `Id` là `null` hoặc `0`, trả về `NotFound()` (hoặc chuyển hướng đến trang lỗi tùy chỉnh).
  - Truy xuất danh mục từ database bằng Entity Framework Core.
  - Nếu danh mục không tồn tại (`null`), trả về `NotFound()`.
  - Nếu tìm thấy, truyền danh mục vào view.
- **Mã nguồn**:
  ```csharp
  public IActionResult Edit(int? id)
  {
      if (id == null || id == 0)
      {
          return NotFound();
      }
      var categoryFromDb = _db.Categories.Find(id);
      if (categoryFromDb == null)
      {
          return NotFound();
      }
      return View(categoryFromDb);
  }
  ```

#### 2. Action Method `Edit` (POST)
- **Mục đích**: Xử lý dữ liệu gửi từ form chỉnh sửa (sẽ được triển khai sau).
- **Lưu ý**: Hiện tại sao chép từ action `Create` và đổi tên thành `Edit`. Cần điều chỉnh logic để cập nhật danh mục thay vì tạo mới.

### Các Phương Thức Truy Xuất Danh Mục từ Database
- **1. Find**:
  - Sử dụng: `_db.Categories.Find(id)`.
  - Đặc điểm:
    - Tìm danh mục dựa trên khóa chính (`Id`).
    - Hiệu quả, nhanh, chỉ hoạt động với khóa chính.
    - Trả về `null` nếu không tìm thấy.
  - Ví dụ:
    ```csharp
    var categoryFromDb = _db.Categories.Find(id);
    ```
- **2. FirstOrDefault**:
  - Sử dụng: `_db.Categories.FirstOrDefault(u => u.Id == id)`.
  - Đặc điểm:
    - Sử dụng LINQ để tìm bản ghi đầu tiên thỏa mãn điều kiện.
    - Linh hoạt, có thể tìm theo bất kỳ thuộc tính nào (không chỉ khóa chính).
    - Trả về `null` nếu không tìm thấy.
  - Ví dụ:
    ```csharp
    var categoryFromDb1 = _db.Categories.FirstOrDefault(u => u.Id == id);
    ```
- **3. Where + FirstOrDefault**:
  - Sử dụng: `_db.Categories.Where(u => u.Id == id).FirstOrDefault()`.
  - Đặc điểm:
    - Tương tự `FirstOrDefault`, nhưng cho phép áp dụng nhiều điều kiện lọc trước khi lấy bản ghi đầu tiên.
    - Phù hợp khi cần xử lý phức tạp hoặc kết hợp nhiều điều kiện.
  - Ví dụ:
    ```csharp
    var categoryFromDb2 = _db.Categories.Where(u => u.Id == id).FirstOrDefault();
    ```
- **So sánh**:
  - `Find`: Tối ưu cho khóa chính, nhanh nhất.
  - `FirstOrDefault`: Linh hoạt, dùng cho điều kiện tùy chỉnh.
  - `Where + FirstOrDefault`: Dùng khi cần lọc phức tạp.
  - **Khuyến nghị**: Sử dụng `FirstOrDefault` trừ khi cần lọc phức tạp, lúc đó dùng `Where + FirstOrDefault`.

### Truyền `Id` từ `Index` View
- **Vấn đề**: Action `Edit` cần `Id` để biết danh mục nào được chỉnh sửa.
- **Giải pháp**: Sử dụng tag helper `asp-route-id` trong nút "Edit" trên `Index.cshtml`.
- **Mã nguồn**:
  ```html
  <a asp-controller="Category" asp-action="Edit" asp-route-id="@obj.Id" class="btn btn-primary mx-2">
      <i class="bi bi-pencil-fill"></i> Edit
  </a>
  ```
- **Giải thích**:
  - `asp-route-id="@obj.Id"`: Truyền `Id` của danh mục vào URL (ví dụ: `/Category/Edit/2`).
  - Tag helper tự động ánh xạ `Id` với tham số `id` trong action `Edit`.

### Thiết Kế View `Edit.cshtml`
- **Yêu cầu**:
  - Giao diện giống `Create.cshtml`, nhưng các trường (`Category Name`, `Display Order`) được điền sẵn dữ liệu từ danh mục được chọn.
  - Form sử dụng model binding để hiển thị và gửi dữ liệu.
- **Hành động**:
  - Sao chép nội dung từ `Create.cshtml` và điều chỉnh để hiển thị dữ liệu từ model.
  - Đảm bảo form gửi đến action `Edit` (POST).
- **Mã nguồn ví dụ** (dự kiến):
  ```html
  @model Category
  <form asp-action="Edit" method="post">
      <input type="hidden" asp-for="Id" />
      <div class="form-group">
          <label asp-for="Name"></label>
          <input asp-for="Name" class="form-control" />
          <span asp-validation-for="Name" class="text-danger"></span>
      </div>
      <div class="form-group">
          <label asp-for="DisplayOrder"></label>
          <input asp-for="DisplayOrder" class="form-control" />
          <span asp-validation-for="DisplayOrder" class="text-danger"></span>
      </div>
      <button type="submit" class="btn btn-primary">Save</button>
  </form>
  @section scripts {
      <partial name="_ValidationScriptsPartial" />
  }
  ```
- **Lưu ý**:
  - Thêm `<input type="hidden" asp-for="Id" />` để gửi `Id` về action `Edit` (POST).
  - Kích hoạt xác thực phía client bằng `_ValidationScriptsPartial`.

### Kết Quả
- Khi nhấn nút "Edit" trên trang `Index`, ứng dụng:
  - Gửi yêu cầu đến `/Category/Edit/{id}`.
  - Action `Edit` (GET) truy xuất danh mục từ database và truyền vào view.
  - View hiển thị form với dữ liệu đã điền sẵn.
	- Xác thực phía client và server vẫn áp dụng như trong `Create`.

### Ghi Chú Thêm
- **Xử lý lỗi**:
  - Nếu `Id` không hợp lệ hoặc danh mục không tồn tại, trả về `NotFound()`.
  - Có thể tùy chỉnh để chuyển hướng đến trang lỗi (`Error.cshtml`).
- **Hiệu suất**:
  - Sử dụng `Find` cho truy vấn đơn giản dựa trên khóa chính.
  - `FirstOrDefault` hoặc `Where` phù hợp khi cần điều kiện phức tạp hơn.
- **Lưu ý triển khai**:
  - Đảm bảo `Id` được truyền đúng từ `Index.cshtml` qua `asp-route-id`.
  - View `Edit.cshtml` cần được tạo và cấu hình trước khi chạy.
- Liên kết liên quan: [[Edit View]], [[ASP.NET Core Tag Helpers]], [[Entity Framework Core Queries]].

### Hướng Dẫn Thao Tác
1. Mở `CategoryController`, thêm action `Edit` (GET) như trên.
2. Cập nhật `Index.cshtml`, thêm `asp-route-id="@obj.Id"` vào thẻ `<a>` của nút "Edit".
3. Sao chép `Create.cshtml` để tạo `Edit.cshtml`, thêm `<input type="hidden" asp-for="Id" />`.
4. Chạy ứng dụng, kiểm tra hành vi khi nhấn nút "Edit" và hiển thị form với dữ liệu điền sẵn.
5. (Tiếp theo) Triển khai action `Edit` (POST) để xử lý cập nhật danh mục.