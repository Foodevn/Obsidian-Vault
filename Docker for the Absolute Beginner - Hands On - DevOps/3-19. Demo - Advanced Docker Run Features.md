## Các Tùy chọn Nâng cao với Lệnh `docker run`

### Giới thiệu
- Bài giảng demo các tùy chọn nâng cao của lệnh `docker run` khi chạy container.
- Nội dung bao gồm:
  - Chỉ định phiên bản image với **tag**.
  - Chế độ **attached** và **detached**.
  - Ánh xạ cổng (port mapping) và lưu trữ dữ liệu (volume mapping) với ứng dụng thực tế (Jenkins).
- Liên kết chéo: [[Các lệnh Docker Run và Thực hành]], [[Cập nhật Image Jenkins]].

### 1. Chỉ định Phiên bản Image với Tag
- **Khái niệm**:
  - Mỗi image trên **Docker Hub** hỗ trợ nhiều **tag** để chỉ định phiên bản cụ thể.
  - Nếu không chỉ định tag, Docker mặc định sử dụng tag `latest`.
  - Ví dụ: `docker run ubuntu` chạy phiên bản mới nhất (ví dụ: Ubuntu 16.04).
- **Cách thực hiện**:
  - Tra cứu tag trên **Docker Hub** [[Docker Hub]] trong phần mô tả của image (ví dụ: repository `ubuntu`).
  - Chỉ định tag bằng cách thêm `:<tag>` vào tên image.
- **Ví dụ**:
  - Chạy Ubuntu 16.04 (mặc định):
    ```bash
    docker run ubuntu cat /etc/*release*
    ```
    - Kết quả: Hiển thị phiên bản Ubuntu 16.04.
  - Chạy Ubuntu 17.10:
    ```bash
    docker run ubuntu:17.10 cat /etc/*release*
    ```
    - Docker tự động tải image Ubuntu 17.10 từ Docker Hub và hiển thị phiên bản.
- **Lưu ý**:
  - Tag có thể là số phiên bản (ví dụ: `17.10`) hoặc tên biệt danh (ví dụ: `artful`).
  - Liên kết chéo: [[Docker Hub]].

### 2. Chế độ Attached và Detached
- **Khái niệm**:
  - **Attached mode** (mặc định): Container chạy ở **foreground**, chiếm console, hiển thị đầu ra trực tiếp.
    - Không thể thoát console cho đến khi container dừng (trừ khi dùng `Ctrl+C` hoặc container tự thoát).
  - **Detached mode**: Container chạy ở **background**, trả lại console ngay lập tức.
- **Cách thực hiện**:
  - **Attached mode**: Chạy lệnh `docker run` mà không có tham số `-d`.
    - Ví dụ:
      ```bash
      docker run ubuntu sleep 15
      ```
      - Container chạy lệnh `sleep 15` trong 15 giây, console bị "treo" cho đến khi container thoát.
  - **Detached mode**: Thêm tham số `-d` để chạy container ở background.
    - Ví dụ:
      ```bash
      docker run -d ubuntu sleep 1500
      ```
      - Container chạy trong 1500 giây, trả lại console ngay lập tức.
      - Kiểm tra container đang chạy:
        ```bash
        docker ps
        ```
      - Dừng container:
        ```bash
        docker stop <container-id>
        ```
  - **Gắn lại container (reattach)**:
    - Sử dụng lệnh:
      ```bash
      docker attach <container-id>
      ```
      - Đưa console về foreground để xem đầu ra của container.
- **Ví dụ thực tế**:
  - Chạy image `timer` (in thời gian mỗi giây):
    ```bash
    docker run timer
    ```
    - Chạy ở foreground, hiển thị thời gian liên tục.
    - Chạy ở detached mode:
      ```bash
      docker run -d timer
      ```
      - Kiểm tra với `docker ps`, gắn lại với `docker attach <container-id>` để xem đầu ra.
- **Lưu ý**:
  - Để dừng container ở foreground, mở terminal khác trên **Docker host** [[Docker Host]] và dùng `docker stop`.
  - Liên kết chéo: [[Docker Host]], [[Labs thực hành]].

### 3. Ứng dụng Thực tế: Chạy Jenkins Container
- **Giới thiệu**:
  - **Jenkins** là hệ thống tích hợp và phân phối liên tục (Continuous Integration/Continuous Delivery) [[Jenkins]].
  - Chạy Jenkins dưới dạng container giúp thử nghiệm nhanh mà không cần cài đặt phức tạp.
- **Cập nhật quan trọng**:
  - Image cũ `jenkins` đã bị deprecated, thay bằng `jenkins/jenkins` [[Cập nhật Image Jenkins]].
- **Lệnh chạy Jenkins**:
  ```bash
  docker run jenkins/jenkins
  ```
  - Tự động tải image `jenkins/jenkins:latest` từ Docker Hub và chạy Jenkins.
  - Jenkins là web server, mặc định chạy trên cổng 8080 (và 50000 cho một số tính năng).
- **Truy cập Jenkins**:
  - **Cách 1: Dùng IP nội bộ**:
    - Mỗi container có IP nội bộ (ví dụ: `172.17.0.2`), chỉ truy cập được từ **Docker host**.
    - Kiểm tra IP với:
      ```bash
      docker inspect <container-id>
      ```
      - Tìm trong phần `Networks` > `IPAddress`.
    - Truy cập qua trình duyệt trên Docker host: `http://172.17.0.2:8080`.
    - Nhập mật khẩu admin ban đầu (hiển thị trong đầu ra của lệnh `docker run`).
  - **Cách 2: Ánh xạ cổng**:
    - Ánh xạ cổng container đến cổng trên Docker host với tham số `-p`:
      ```bash
      docker run -p 8080:8080 jenkins/jenkins
      ```
    - Truy cập qua IP của Docker host (ví dụ: `192.168.1.14`): `http://192.168.1.14:8080`.
  - **Lưu ý**:
    - Cần dừng container hiện tại (`docker stop <container-id>`) trước khi chạy lại với ánh xạ cổng.
    - Liên kết chéo: [[Các lệnh Docker Run và Thực hành]].

### 4. Lưu trữ Dữ liệu với Volume Mapping
- **Vấn đề**:
  - Jenkins lưu trữ dữ liệu cấu hình trong thư mục `~/.jenkins` bên trong container.
  - Nếu container bị xóa, dữ liệu (cấu hình, plugin, job) sẽ mất.
- **Giải pháp**:
  - Ánh xạ thư mục trên Docker host vào thư mục `~/.jenkins` trong container bằng tham số `-v`.
  - Ví dụ:
    ```bash
    docker run -p 8080:8080 -v /my-jenkins-data:~/.jenkins jenkins/jenkins
    ```
    - `/my-jenkins-data`: Thư mục trên Docker host.
    - `~/.jenkins`: Thư mục mặc định lưu dữ liệu Jenkins trong container.
- **Thực hiện**:
  - Tạo thư mục trên host:
    ```bash
    mkdir /my-jenkins-data
    ```
  - Chạy container với volume mapping:
    ```bash
    docker run -p 8080:8080 -v /my-jenkins-data:~/.jenkins -u root jenkins/jenkins
    ```
    - Tham số `-u root` giải quyết vấn đề quyền truy cập thư mục.
  - Cấu hình Jenkins (cài plugin, tạo job, v.v.).
  - Dừng container và chạy lại với cùng volume mapping:
    ```bash
    docker stop <container-id>
    docker run -p 8080:8080 -v /my-jenkins-data:~/.jenkins -u root jenkins/jenkins
    ```
  - Kết quả: Dữ liệu (job, cấu hình) được giữ nguyên nhờ volume mapping.
- **Lợi ích**:
  - Dữ liệu được lưu trữ vĩnh viễn trên Docker host.
  - Có thể tái sử dụng khi chạy container mới.
- **Lưu ý**:
  - Kiểm tra hướng dẫn trên Docker Hub để đảm bảo ánh xạ đúng thư mục [[Docker Hub]].
  - Liên kết chéo: [[Cập nhật Image Jenkins]], [[Labs thực hành]].

### Ghi chú thêm
- **Liên kết chéo**:
  - [[Docker Hub]]: Tra cứu tag và hướng dẫn cho `jenkins/jenkins`.
  - [[Jenkins]]: Hệ thống CI/CD.
  - [[Docker Host]]: Máy chủ chạy Docker.
  - [[Labs thực hành]]: Thực hành các lệnh nâng cao (`-d`, `-p`, `-v`) với Jenkins.
- **Hướng dẫn thực hành**:
  - Thử chạy `jenkins/jenkins` với các tùy chọn `-d`, `-p`, `-v`.
  - Kiểm tra IP nội bộ với `docker inspect` và truy cập Jenkins qua IP nội bộ hoặc cổng ánh xạ.
  - Tạo job trên Jenkins, dừng container, và kiểm tra dữ liệu được lưu trữ khi chạy lại.

Chúc bạn thành công với bài thực hành!